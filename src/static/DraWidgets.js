function DraWidgets(window, document, translate, id, imagePath, gName) {

var gToolTip = new ToolTip(window, document)

var gGenerators = {}

var gWidgets = new TabGen4(gName)
gWidgets.setNextId(id)


this.imagePath = imagePath || "/static/images/"


var TreeIconWidth = 30
var DarkBackground = "#455A64"
var DockHeaderColor = "#E2EDF5"
var SlashColor = "cyan"
var NormalBack = "linear-gradient(#758A94, #455A64)"
var SpecialBack = "linear-gradient(coral, #CD5B45)"
var self = this

// Autogenerated with DRAKON Editor 1.33


function Check_measureWidth(height) {
    return this.width
}

function Check_setChecked(checked) {
    this.isChecked = checked
    setCheckboxImage(this)
}

function EditBox_setRect() {
    var button, div, edit, height, input, left, rect, top, width
    div = get(this.id)
    input = this.input
    button = this.button
    rect = this.rect
    left = rect.left
    top = rect.top
    width = rect.width
    height = rect.height
    setPos(
        div,
        left,
        top,
        width,
        height
    )
    edit = get(this.id + "_edit")
    setWidth(
        edit,
        width
    )
}

function HDock_measureHeight(width) {
    return this.height
}

function HDock_setRect() {
    var centerWidth, div, height, hp, left, leftX, rect, rightX, top, vp, width
    rect = this.rect
    left = rect.left
    top = rect.top
    width = rect.width
    height = rect.height
    div = get(this.id)
    setPos(
        div,
        left,
        top,
        width,
        height
    )
    leftX = 0
    var _ind2501 = 0;
    var _col2501 = this.lefts;
    var _len2501 = _col2501.length;
    while (true) {
        if (_ind2501 < _len2501) {
            
        } else {
            break;
        }
        var kid = _col2501[_ind2501];
        hp = kid.hPadding || 0
        vp = kid.vPadding || 0
        kid.width = kid.measureWidth(this.height)
        leftX += hp
        setRect(
            kid,
            leftX,
            vp,
            kid.width,
            height - vp * 2
        )
        leftX += kid.width
        _ind2501++;
    }
    rightX = width
    var _ind2518 = 0;
    var _col2518 = this.rights;
    var _len2518 = _col2518.length;
    while (true) {
        if (_ind2518 < _len2518) {
            
        } else {
            break;
        }
        var kid = _col2518[_ind2518];
        hp = kid.hPadding || 0
        vp = kid.vPadding || 0
        kid.width = kid.measureWidth(this.height)
        rightX -= (kid.width + hp)
        setRect(
            kid,
            rightX,
            vp,
            kid.width,
            height - vp * 2
        )
        _ind2518++;
    }
    if (this.center) {
        centerWidth = rightX - leftX
        centerWidth = Math.max(0, centerWidth)
        setRect(
            this.center,
            leftX,
            0,
            centerWidth,
            height
        )
    }
}

function ListGrid_addItem(widget, item) {
    var cell, column, columns, i, listId, row, table
    columns = widget.columns
    if (columns.length == item.cells.length) {
        listId = makeListId(widget.id)
        table = get(listId)
        row = make(table, "tr")
        row.id = makeItemId(widget.id, item.id)
        item.row = row
        row.className = "list_item"
        bindEvent(
            row,
            "click",
            widget.id,
            item.id,
            null,
            false
        )
        bindOnContext(
            row,
            widget.id,
            item.id,
            null
        )
        i = 0;
        while (true) {
            if (i < columns.length) {
                
            } else {
                break;
            }
            cell = item.cells[i]
            column = columns[i]
            addListGridCell(
                column,
                row,
                cell,
                widget.id,
                item.id,
                i
            )
            i++;
        }
        widget.items.push(item)
    } else {
        raise("Wrong number of cells in row")
    }
}

function ListGrid_check(id) {
    var i
    i = getItemOrdinal(this.items, id)
    checkItem(this, i)
}

function ListGrid_checkAll() {
    var i
    i = 0;
    while (true) {
        if (i < this.items.length) {
            
        } else {
            break;
        }
        checkItem(this, i)
        i++;
    }
}

function ListGrid_getChecked() {
    var result
    result = {
        checked : [],
        unchecked : []
    }
    var _ind2894 = 0;
    var _col2894 = this.items;
    var _len2894 = _col2894.length;
    while (true) {
        if (_ind2894 < _len2894) {
            
        } else {
            break;
        }
        var item = _col2894[_ind2894];
        if (item.checked) {
            result.checked.push(item.id)
        } else {
            result.unchecked.push(item.id)
        }
        _ind2894++;
    }
    return result
}

function ListGrid_getItem(id) {
    var i
    i = getItemOrdinal(this.items, id)
    if (i == -1) {
        return null
    } else {
        return this.items[i]
    }
}

function ListGrid_isChecked(id) {
    var i
    i = getItemOrdinal(this.items, id)
    if (i == -1) {
        return false
    } else {
        return !!this.items[i].checked
    }
}

function ListGrid_mark(id) {
    var _ind3865 = 0;
    var _col3865 = this.items;
    var _len3865 = _col3865.length;
    while (true) {
        if (_ind3865 < _len3865) {
            
        } else {
            break;
        }
        var item = _col3865[_ind3865];
        if (item.id == id) {
            item.row.className = "list_item_marked"
        } else {
            item.row.className = "list_item"
        }
        _ind3865++;
    }
}

function ListGrid_measureHeight(width) {
    var height = WTextButton_measureHeight.call(this, width)
    return height + 3
}

function ListGrid_remove(id) {
    var div, divId, ordinal
    ordinal = getItemOrdinal(this.items, id)
    if (ordinal == -1) {
        
    } else {
        removeAt(this.items, ordinal)
        divId = makeItemId(this.id, id)
        div = get(divId)
        deleteDiv(div)
    }
}

function ListGrid_setActive(id) {
    var itemId, row
    var _ind2867 = 0;
    var _col2867 = this.items;
    var _len2867 = _col2867.length;
    while (true) {
        if (_ind2867 < _len2867) {
            
        } else {
            break;
        }
        var item = _col2867[_ind2867];
        itemId = makeItemId(this.id, item.id)
        row = get(itemId)
        if (item.id == id) {
            row.className = "list_item_marked"
        } else {
            row.className = "list_item"
        }
        _ind2867++;
    }
}

function ListGrid_setItemText(rowId, cellId, text) {
    var id
    id = makeCellId(
        makeItemId(this.id, rowId),
        cellId
    )
    HtmlUtils.setText(id, text)
}

function ListGrid_setItems(items, buttons) {
    var list, listId
    this.items = []
    this.buttons = buttons || []
    listId = makeListId(this.id)
    list = get(listId)
    list.innerHTML = ""
    var _ind2757 = 0;
    var _col2757 = items;
    var _len2757 = _col2757.length;
    while (true) {
        if (_ind2757 < _len2757) {
            
        } else {
            break;
        }
        var item = _col2757[_ind2757];
        ListGrid_addItem(this, item)
        _ind2757++;
    }
    List_updateNoItems(this)
}

function ListGrid_uncheck(id) {
    var i
    i = getItemOrdinal(this.items, id)
    uncheckItem(this, i)
}

function ListGrid_uncheckAll() {
    var i
    i = 0;
    while (true) {
        if (i < this.items.length) {
            
        } else {
            break;
        }
        uncheckItem(this, i)
        i++;
    }
}

function List_addItem(widget, item) {
    var list, listId, row
    widget.items.push(item)
    listId = makeListId(widget.id)
    list = get(listId)
    row = make(list, "div")
    row.id = makeItemId(widget.id, item.id)
    setListRowFormat(row)
    HtmlUtils.setDivText(row, item.text)
    bindEvent(
        row,
        "click",
        widget.id,
        item.id,
        null,
        false
    )
    bindOnContext(
        row,
        widget.id,
        item.id,
        null
    )
}

function List_remove(id) {
    var div, divId, ordinal
    ordinal = getItemOrdinal(this.items, id)
    if (ordinal == -1) {
        
    } else {
        removeAt(this.items, ordinal)
        divId = makeItemId(this.id, id)
        div = get(divId)
        deleteDiv(div)
    }
}

function List_setItemText(id, text) {
    var divId
    divId = makeItemId(this.id, id)
    HtmlUtils.setText(divId, text)
}

function List_setItems(items) {
    var list, listId
    this.items = []
    listId = makeListId(this.id)
    list = get(listId)
    list.innerHTML = ""
    var _ind2667 = 0;
    var _col2667 = items;
    var _len2667 = _col2667.length;
    while (true) {
        if (_ind2667 < _len2667) {
            
        } else {
            break;
        }
        var item = _col2667[_ind2667];
        List_addItem(this, item)
        _ind2667++;
    }
    List_updateNoItems(this)
}

function List_updateNoItems(widget) {
    var list, no
    list = makeListId(widget.id)
    no = makeNoItemsId(widget.id)
    if (widget.items.length == 0) {
        display(list, "none")
        display(no, "block")
    } else {
        display(list, "block")
        display(no, "none")
    }
    if (widget.buttDiv) {
        widget.buttDiv.innerHTML = ""
        var _ind4295 = 0;
        var _col4295 = widget.buttons;
        var _len4295 = _col4295.length;
        while (true) {
            if (_ind4295 < _len4295) {
                
            } else {
                break;
            }
            var button = _col4295[_ind4295];
            addButton(widget.buttDiv, button)
            _ind4295++;
        }
    }
}

function Many_measureHeight(width) {
    return this.active.measureHeight(width)
}

function Many_measureWidth(height) {
    return this.active.measureWidth(height)
}

function Many_setActive(id) {
    var index
    index = findChild(this, id)
    if (index == -1) {
        raise("Many.setActive: bad child id: " + id)
    } else {
        if (this.active == null) {
            
        } else {
            display(this.active.id, "none")
        }
        this.active = this.kids[index]
        display(id, "inline-block")
    }
}

function Many_setRect() {
    var height, rect, width
    setWidgetDiv(this)
    rect = this.rect
    
    width = rect.width
    height = rect.height
    setRect(
        this.active,
        0,
        0,
        width,
        height
    )
}

function Multipane_makeComboId(widgetId) {
    return widgetId + "_combo"
}

function Multipane_makeManyId(widgetId) {
    return widgetId + "_many"
}

function Multipane_setActive(id) {
    var comboId, select
    if (id in this.tabs) {
        comboId = Multipane_makeComboId(this.id)
        select = get(comboId)
        select.value = id
        onPaneChange(this.id, id)
    } else {
        raise("Multipane.setActive: bad child id: " + id)
    }
}

function Page_measureHeight(width) {
    var height, kidWidth
    height = this.padding
    kidWidth = width - this.padding * 2
    var _ind2571 = 0;
    var _col2571 = this.kids;
    var _len2571 = _col2571.length;
    while (true) {
        if (_ind2571 < _len2571) {
            
        } else {
            break;
        }
        var kid = _col2571[_ind2571];
        kid.height = kid.measureHeight(kidWidth)
        height += (kid.height + this.padding)
        _ind2571++;
    }
    return height
}

function Page_setRect() {
    var SCROLL_WIDTH, actualHeight, actualWidth, div, finalHeight, height, inner, kidWidth, left, rect, top, width, y
    SCROLL_WIDTH = 15
    rect = this.rect
    left = rect.left
    top = rect.top
    width = rect.width
    height = rect.height
    div = get(this.id)
    actualHeight = this.measureHeight(width)
    actualWidth = width
    if (actualHeight > height) {
        actualWidth = width - SCROLL_WIDTH
        actualHeight = this.measureHeight(actualWidth)
        finalHeight = height
        div.style.overflowY = "scroll"
    } else {
        finalHeight = actualHeight
        div.style.overflow = "hidden"
    }
    inner = get(makeInnerId(this))
    inner.style.height = actualHeight + "px"
    setPos(
        div,
        left,
        top,
        width,
        finalHeight
    )
    y = this.padding
    kidWidth = actualWidth - this.padding * 2
    var _ind2583 = 0;
    var _col2583 = this.kids;
    var _len2583 = _col2583.length;
    while (true) {
        if (_ind2583 < _len2583) {
            
        } else {
            break;
        }
        var kid = _col2583[_ind2583];
        setRect(
            kid,
            this.padding,
            y,
            kidWidth,
            kid.height
        )
        y += (kid.height + this.padding)
        _ind2583++;
    }
}

function Path_addStage(text, id, clickable) {
    var slash, stage, td
    td = this.cell
    if (td.innerHTML == "") {
        
    } else {
        slash = make(td, "span")
        slash.style.display = "inline"
        slash.style.color = SlashColor
        //make(td, "wbr")
        HtmlUtils.setDivText(slash, " › ")
        if (clickable) {
            
        } else {
            make(td, "br")
        }
    }
    stage = make(td, "span")
    stage.style.display = "inline"
    stage.style.color = "white"
    if (id) {
        this.idToDiv[id] = stage
    }
    HtmlUtils.setDivText(stage, text)
    if (clickable) {
        stage.style.fontWeight = "normal"
        stage.style.fontSize = "80%"
        stage.style.cursor = "pointer"
        //stage.style.textDecoration = "underline"
        bindEvent(
            stage,
            "click",
            this.id,
            id,
            null,
            false
        )
    } else {
        stage.style.fontWeight = "normal"
        stage.style.fontSize = "100%"
    }
}

function Path_clear() {
    this.cell.innerHTML = ""
}

function Path_renameStage(id, name) {
    var div
    div = this.idToDiv[id]
    if (div) {
        HtmlUtils.setDivText(div, name)
    }
}

function Search_focus() {
    this.input.focus()
}

function Search_getValue() {
    return this.input.value
}

function Search_setRect() {
    var button, div, height, innerHeight, innerWidth, input, inputWidth, left, rect, top, width
    div = get(this.id)
    input = this.input
    button = this.button
    rect = this.rect
    left = rect.left
    top = rect.top
    width = rect.width
    height = rect.height
    innerWidth = width - 2
    innerHeight = height - 2
    inputWidth = innerWidth - height
    setPos(
        div,
        left,
        top,
        width,
        height
    )
    setPos(
        input,
        1,
        0,
        inputWidth - 1,
        innerHeight - 1
    )
    setPos(
        button,
        inputWidth,
        0,
        innerHeight,
        innerHeight
    )
}

function TextButton_enable(enabled) {
    var div, style
    div = get(this.id)
    style = div.style
    if (enabled) {
        style.background = NormalBack
        div.className = "common_button"
    } else {
        style.background = "#909090"
        div.className = ""
    }
}

function TextButton_measureWidth(height) {
    var div, style, width
    if (this.customWidth) {
        return this.customWidth
    } else {
        div = get(this.id)
        style = div.style
        style.display = "inline-block"
        style.position = "absolute"
        delete style.width
        style.left = "0px"
        style.top = "0px"
        width = div.offsetWidth
        return width
    }
}

function VDock_measureHeight(width) {
    var bottom, top
    top = this.top.measureHeight(width)
    bottom = this.center.measureHeight(width)
    return top + bottom
}

function VDock_setRect() {
    var bottomHeight, div, height, left, rect, top, topHeight, width
    rect = this.rect
    left = rect.left
    top = rect.top
    width = rect.width
    height = rect.height
    div = get(this.id)
    topHeight = this.top.measureHeight(width)
    bottomHeight = height - topHeight
    bottomHeight = Math.max(0, bottomHeight)
    setPos(
        div,
        left,
        top,
        width,
        height
    )
    setRect(this.top, 0, 0, width, topHeight)
    setRect(this.center, 0, topHeight, width, bottomHeight)
}

function VPanel_measureHeight(width) {
    var height
    height = 0
    var _ind2394 = 0;
    var _col2394 = this.kids;
    var _len2394 = _col2394.length;
    while (true) {
        if (_ind2394 < _len2394) {
            
        } else {
            break;
        }
        var kid = _col2394[_ind2394];
        kid.height = kid.measureHeight(width)
        height += kid.height
        _ind2394++;
    }
    return height
}

function VPanel_measureWidth() {
    return this.width
}

function VPanel_setRect() {
    var div, height, left, rect, top, width, y
    rect = this.rect
    left = rect.left
    top = rect.top
    width = rect.width
    height = rect.height
    div = get(this.id)
    setPos(
        div,
        left,
        top,
        width,
        height
    )
    y = 0
    var _ind2384 = 0;
    var _col2384 = this.kids;
    var _len2384 = _col2384.length;
    while (true) {
        if (_ind2384 < _len2384) {
            
        } else {
            break;
        }
        var kid = _col2384[_ind2384];
        kid.height = kid.measureHeight(width)
        setRect(
            kid,
            0,
            y,
            width,
            kid.height
        )
        y += kid.height
        _ind2384++;
    }
}

function WTextButton_measureHeight(width) {
    var div, height, style
    div = get(this.id)
    style = div.style
    style.display = "inline-block"
    style.position = "absolute"
    delete style.height
    style.left = "0px"
    style.top = "0px"
    style.width = width + "px"
    style.height = ""
    height = div.offsetHeight
    return height
}

function addButton(parent, button) {
    var div = make(parent, "div")
    div.className = "panic_button"
    HtmlUtils.setDivText(div, translate(button.text))
    div.style.display = "inline-block"
    div.style.margin = "10px"
    div.onclick = button.action
    if (button.main) {
        div.style.background = SpecialBack
    }
}

function addListGridCell(column, row, cell, widgetId, rowId, cellId) {
    var button, id, img, style, td
    var _sw28160000_ = 0;
    id = makeCellId(
        makeItemId(widgetId, rowId),
        cellId
    )
    td = make(row, "td")
    style = td.style
    style.width = column.width
    _sw28160000_ = column.type;
    if (_sw28160000_ === "text") {
        style.padding = "6px"
        style.lineHeight = "120%"
        HtmlUtils.setDivText(td, cell.text)
        td.id = id
    } else {
        if (_sw28160000_ === "image") {
            img = makeImg(
                td,
                cell.src,
                cell.width,
                cell.height
            )
            if (column.clickable) {
                td.className = "black_hover common_button"
                //style.cursor = "default"
                bindEvent(
                    td,
                    "click",
                    widgetId,
                    rowId,
                    cellId,
                    true
                )
            }
            if (cell.paddingLeft) {
                style.paddingLeft = cell.paddingLeft
            }
            if (cell.paddingRight) {
                style.paddingRight = cell.paddingRight
            }
            img.id = id
        } else {
            if (_sw28160000_ === "button") {
                
            } else {
                throw "Unexpected switch value: " + _sw28160000_;
            }
            button = make(td, "div")
            style.padding = "3px"
            makeInternalButtonStyle(button)
            bindEvent(
                td,
                "click",
                widgetId,
                rowId,
                cellId,
                true
            )
            HtmlUtils.setDivText(
                button,
                translate(cell.text)
            )
            button.id = id
        }
    }
}

function addTooltip(element, text) {
    if (text) {
        gToolTip.makeFromElement(
            element,
            translate(text)
        )
    }
}

function bindEvent(element, name, widgetId, rowId, cellId, stopProcessing) {
    var callback, fullname
    callback = function(evt) {
        fireEvent(
            evt,
            name,
            widgetId,
            rowId,
            cellId,
            stopProcessing
        )
    }
    fullname = "on" + name
    element[fullname] = callback
}

function bindEventInternal(element, name, widget, callback) {
    var callback2, fullname, wrapped
    callback2 = function(evt) {
        callback(evt, widget)
    }
    wrapped = self.wrapException(callback2)
    fullname = "on" + name
    element[fullname] = wrapped
}

function bindOnContext(element, widgetId, rowId, cellId) {
    var callback
    callback = function(evt) {
    	HtmlUtils.stopPropagation(evt)
    	scheduleEvent(
    		evt,
    		"contextmenu",
    		widgetId,
    		rowId,
    		cellId
    	)
    	return false
    }
    element.oncontextmenu = callback
}

function buildPaneCombo(div, node, widget) {
    var items, onChange, option, select
    select = make(div, "select")
    select.id = Multipane_makeComboId(node.parentId)
    items = Utils.objectValues(node.tabs)
    items.sort(byLabel)
    var _ind4224 = 0;
    var _col4224 = items;
    var _len4224 = _col4224.length;
    while (true) {
        if (_ind4224 < _len4224) {
            
        } else {
            break;
        }
        var item = _col4224[_ind4224];
        option = make(select, "option")
        option.value = item.id
        option.text = item.label
        _ind4224++;
    }
    onChange = function(evt) {
        onPaneChange(node.parentId, evt.currentTarget.value)
    }
    select.onchange = onChange
    widget.measureWidth = WTextButton_measureHeight
}

function byLabel(left, right) {
    var leftName, rightName
    leftName = left.label
    rightName = right.label
    return leftName.localeCompare(rightName)
}

function checkItem(widget, i) {
    var cellId, id, img, item, rowId
    item = widget.items[i]
    id = item.id
    rowId = makeItemId(widget.id, id)
    cellId = makeCellId(rowId, "0")
    img = get(cellId)
    img.src = makeImagePath("checked.png")
    item.checked = true
}

function clearDiv(element) {
    element.innerHTML = ""
}

function clearSearch(widget) {
    widget.input.value = ""
    setSearchIcon(widget)
}

function compareTreeItems(left, right) {
    if (left.rank < right.rank) {
        return -1
    } else {
        if (left.rank > right.rank) {
            return 1
        } else {
            return left.text.localeCompare(right.text)
        }
    }
}

function connect(widget, field, other) {
    gWidgets.set(
        "widgets",
        widget.id,
        field,
        other.id
    )
}

function copyArray(array) {
    return array.slice(0)
}

function copyClass(src, div) {
    if (src.className) {
        div.className += (" " + src.className)
    }
}

function copyProperty(src, name, dst) {
    if (name in src) {
        dst[name] = src[name]
    }
}

function copyStyle(src, div) {
    if (src.style) {
        var _ind180 = 0;
        var _col180 = src.style;
        var _keys180 = Object.keys(_col180); 
        var _len180 = _keys180.length;
        while (true) {
            if (_ind180 < _len180) {
                
            } else {
                break;
            }
            var key = _keys180[_ind180]; var value = _col180[key];
            div.style[key] = value
            _ind180++;
        }
    }
}

function createCheck(div, node, widget) {
    var height, style, width
    style = div.style
    div.className = "common_button"
    noContext(div)
    width = getProperty(node, "width")
    height = getProperty(node, "height")
    widget.width = width
    widget.height = height
    style.display = "inline-block"
    style.width = width + "px"
    style.height = height + "px"
    style.backgroundSize = width + "px " + height + "px"
    style.backgroundPosition = "center"
    style.backgroundRepeat = "no-repeat"
    setCheckboxImage(widget)
    div.style.cursor = "default"
    bindEventInternal(
        div,
        "click",
        widget,
        onCheckClick
    )
    widget.setRect = default_setRect
    widget.measureWidth = Check_measureWidth
    widget.setChecked = Check_setChecked
}

function createCustom(div, node, widget) {
    var builder
    builder = getProperty(node, "builder")
    builder(div, node, widget)
    widget.setRect = default_setRect
    widget.measureHeight = WTextButton_measureHeight
    widget.measureWidth = TextButton_measureWidth
}

function createDummy(div, node, widget) {
    copyStyle(node, div)
    widget.setRect = default_setRect
    widget.measureWidth = dummy_measureWidth
    widget.measureHeight = dummy_measureHeight
    copyProperty(node, "height", widget)
    copyProperty(node, "width", widget)
}

function createEditBox(div, node, widget) {
    var editor, error, label, lower, type, water
    type = getProperty(node, "editType")
    water = getPropertyOr(node, "water", "")
    error = make(div, "div")
    error.id = node.id + "_error"
    error.style.color = "#600000"
    error.style.display = "none"
    error.style.fontWeight = "bold"
    error.style.fontSize = "90%"
    lower = make(div, "div")
    editor = make(lower, "input")
    editor.type = type
    if (water) {
        label = make(lower, "div")
        label.style.position = "absolute"
        label.style.left = "10px"
        label.style.bottom = "10px"
        label.style.color = "grey"
        label.style.pointerEvents = "none"
        HtmlUtils.setDivText(label, water)
        HtmlUtils.setPasswordWatermark(editor, label, water)
    }
    editor.className = "mousetrap"
    editor.style.padding = "10px"
    editor.style.margin = "0px"
    editor.style.border = "solid 1px #707070"
    copyStyle(node, div)
    bindEvent(
        editor,
        "keypress",
        widget.id,
        null,
        null,
        false
    )
    editor.id = node.id + "_edit"
    widget.setRect = EditBox_setRect
    widget.measureHeight = WTextButton_measureHeight
}

function createHDock(div, node, widget) {
    var kid
    widget.height = getProperty(node, "height")
    copyStyle(node, div)
    widget.setRect = HDock_setRect
    widget.measureHeight = HDock_measureHeight
    widget.lefts = []
    widget.rights = []
    gWidgets.createLink(
        "widgets",
        "leftLink",
        "widgets",
        "lefts",
        "list"
    )
    gWidgets.createLink(
        "widgets",
        "rightLink",
        "widgets",
        "rights",
        "list"
    )
    gWidgets.createLink(
        "widgets",
        "center",
        "widgets",
        "p2",
        "simple"
    )
    disconnectOnDestruct(
        widget,
        ["center"]
    )
    var _ind2480 = 0;
    var _col2480 = getProperty(node, "lefts");
    var _len2480 = _col2480.length;
    while (true) {
        if (_ind2480 < _len2480) {
            
        } else {
            break;
        }
        var childNode = _col2480[_ind2480];
        kid = createWidgetUnder(div, childNode, widget)
        connect(kid, "leftLink", widget)
        copyProperty(childNode, "vPadding", kid)
        copyProperty(childNode, "hPadding", kid)
        _ind2480++;
    }
    var _ind3956 = 0;
    var _col3956 = getProperty(node, "rights");
    var _len3956 = _col3956.length;
    while (true) {
        if (_ind3956 < _len3956) {
            
        } else {
            break;
        }
        var childNode = _col3956[_ind3956];
        kid = createWidgetUnder(div, childNode, widget)
        connect(kid, "rightLink", widget)
        copyProperty(childNode, "vPadding", kid)
        copyProperty(childNode, "hPadding", kid)
        _ind3956++;
    }
    if (node.center) {
        kid = createWidgetUnder(
            div,
            node.center,
            widget
        )
        connect(widget, "center", kid)
    }
}

function createImageButton(div, node, widget) {
    var height, image, style, url, width
    style = div.style
    div.className = "common_button"
    noContext(div)
    width = getProperty(node, "width")
    height = getProperty(node, "height")
    image = getProperty(node, "image")
    widget.width = width
    widget.height = height
    copyStyle(node, div)
    url = makeImagePathUrl(image)
    style.display = "inline-block"
    style.width = width + "px"
    style.height = height + "px"
    style.backgroundImage = url
    style.backgroundSize = width + "px " + height + "px"
    widget.setRect = default_setRect
    widget.measureWidth = dummy_measureWidth
    widget.measureHeight = dummy_measureHeight
    bindEvent(
        div,
        "click",
        node.id,
        null,
        null,
        true
    )
    addTooltip(div, node.tooltip)
}

function createLabel(div, node, widget) {
    var text, textId
    div.style.padding = "5px"
    textId = getProperty(node, "text")
    if (node.raw) {
        text = textId
    } else {
        text = translate(textId)
    }
    HtmlUtils.setDivText(div, text)
    copyStyle(node, div)
    widget.setRect = default_setRect
    widget.measureWidth = TextButton_measureWidth
    widget.measureHeight = WTextButton_measureHeight
}

function createList(div, node, widget) {
    var noItems, table
    widget.items = []
    widget.buttons = []
    div.style.overflowY = "scroll"
    copyStyle(node, div)
    table = make(div, "div")
    noItems = make(div, "div")
    table.id = makeListId(node.id)
    noItems.id = makeNoItemsId(node.id)
    HtmlUtils.setDivText(
        noItems,
        translate("MES_NO_ITEMS")
    )
    noItems.style.textAlign = "center"
    noItems.style.padding = "30px"
    noItems.style.color = "#ff8080"
    List_updateNoItems(widget)
    widget.setRect = default_setRect
    widget.setItems = List_setItems
    widget.remove = List_remove
    widget.setItemText = List_setItemText
}

function createListGrid(div, node, widget) {
    var noItems, table
    widget.items = []
    widget.columns = getProperty(node, "columns")
    widget.checkable = node.checkable || false
    if (node.noScroll) {
        
    } else {
        div.style.overflowY = "scroll"
    }
    bindOnContext(
        div,
        widget.id,
        null,
        null
    )
    copyStyle(node, div)
    table = make(div, "table")
    noItems = make(div, "div")
    widget.buttons = []
    widget.buttDiv = make(div, "div")
    widget.buttDiv.style.paddingTop = "40px"
    table.style.width = "100%"
    table.id = makeListId(node.id)
    noItems.id = makeNoItemsId(node.id)
    HtmlUtils.setDivText(
    	noItems,
    	translate("MES_NO_ITEMS")
    )
    noItems.style.textAlign = "center"
    noItems.style.padding = "30px"
    noItems.style.color = "#ff8080"
    List_updateNoItems(widget)
    widget.setRect = default_setRect
    widget.setItems = ListGrid_setItems
    widget.remove = ListGrid_remove
    widget.setItemText = ListGrid_setItemText
    widget.setActive = ListGrid_setActive
    widget.check = ListGrid_check
    widget.uncheck = ListGrid_uncheck
    widget.getChecked = ListGrid_getChecked
    widget.checkAll = ListGrid_checkAll
    widget.uncheckAll = ListGrid_uncheckAll
    widget.isChecked = ListGrid_isChecked
    widget.mark = ListGrid_mark
    widget.getItem = ListGrid_getItem
    widget.measureHeight = ListGrid_measureHeight
    if (node.rows) {
        widget.setItems(node.rows)
    }
}

function createMany(div, node, widget) {
    var kid, kids
    widget.active = null
    kids = getProperty(node, "kids")
    var _ind3275 = 0;
    var _col3275 = kids;
    var _len3275 = _col3275.length;
    while (true) {
        if (_ind3275 < _len3275) {
            
        } else {
            break;
        }
        var childNode = _col3275[_ind3275];
        kid = createWidgetUnder(
            div,
            childNode,
            widget
        )
        display(kid.id, "none")
        _ind3275++;
    }
    copyStyle(node, div)
    widget.setRect = Many_setRect
    widget.measureHeight = Many_measureHeight
    widget.measureWidth = Many_measureWidth
    widget.setActive = Many_setActive
}

function createMultipane(div, node, widget) {
    var button, combo, header, kids, label, many, style, tab, tabs, vdock
    widget.active = null
    kids = getProperty(node, "kids")
    many = {
        id : Multipane_makeManyId(widget.id),
        type : "many",
        kids : kids
    }
    tabs = {}
    var _ind4175 = 0;
    var _col4175 = kids;
    var _len4175 = _col4175.length;
    while (true) {
        if (_ind4175 < _len4175) {
            
        } else {
            break;
        }
        var childNode = _col4175[_ind4175];
        label = translate(
            getProperty(childNode, "tab")
        )
        tab = {
            id : getProperty(childNode, "id"),
            label : label
        }
        tabs[tab.id] = tab
        _ind4175++;
    }
    combo = {
        type : "custom",
        builder : buildPaneCombo,
        tabs : tabs,
        parentId : widget.id
    }
    button = {
        id : node.id + "_close",
        type : "image_button",
        image : "grey-cross.png",
        style : {},
        width : 30,
        height : 30
    }
    style = {
        background : DockHeaderColor,
        borderBottom : darkLine()
    }
    header = {
        type : "hdock",
        lefts : [combo],
        rights : [button],
        height : 30,
        style : style
    }
    vdock = {
        id : node.id,
        type : "vdock",
        top : header,
        center : many
    }
    createVDock(
        div,
        vdock,
        widget
    )
    widget.tabs = tabs
    widget.setActive = Multipane_setActive
}

function createPage(div, node, widget) {
    var innerDiv, kids
    innerDiv = make(div, "innerDiv")
    innerDiv.id = makeInnerId(widget)
    kids = getProperty(node, "kids")
    widget.padding = node.padding || 0
    widget.width = node.width
    var _ind2559 = 0;
    var _col2559 = kids;
    var _len2559 = _col2559.length;
    while (true) {
        if (_ind2559 < _len2559) {
            
        } else {
            break;
        }
        var childNode = _col2559[_ind2559];
        createWidgetUnder(
            innerDiv,
            childNode,
            widget
        )
        _ind2559++;
    }
    copyStyle(node, innerDiv)
    widget.setRect = Page_setRect
    widget.measureHeight = Page_measureHeight
    widget.measureWidth = VPanel_measureWidth
}

function createPane(div, node, widget) {
    var button, header, kidNode, label, style, vdock
    label = {
        type : "label",
        text : getProperty(node, "text"),
        style : {padding:"7px"}
    }
    button = {
        id : node.id + "_close",
        type : "image_button",
        image : "grey-cross.png",
        style : {},
        width : 30,
        height : 30
    }
    style = {
        background : DockHeaderColor,
        borderBottom : darkLine()
    }
    header = {
        type : "hdock",
        lefts : [label],
        rights : [button],
        height : 30,
        style : style
    }
    kidNode = getProperty(node, "kid")
    vdock = {
        id : node.id,
        type : "vdock",
        top : header,
        center : kidNode
    }
    createVDock(
        div,
        vdock,
        widget
    )
}

function createPath(div, node, widget) {
    var style, table, td, tr
    widget.idToDiv = {}
    table = make(div, "table")
    table.style.tableLayout = "fixed"
    table.width = "100%"
    widget.table = table
    tr = make(table, "tr")
    td = make(tr, "td")
    style = td.style
    widget.cell = td
    style.verticalAlign = "middle"
    style.color = "white"
    style.paddingLeft = "5px"
    //style.wordWrap = "break-word"
    style.lineHeight = "130%"
    style.whiteSpace = "nowrap"
    style.overflow = "hidden"
    style.height = "52px"
    copyStyle(node, td)
    widget.setRect = default_setRect
    widget.measureHeight = WTextButton_measureHeight
    widget.measureWidth = TextButton_measureWidth
    widget.addStage = Path_addStage
    widget.clear = Path_clear
    widget.renameStage = Path_renameStage
}

function createSearch(div, node, widget) {
    var height, img, input, width
    width = getProperty(node, "width")
    widget.width = width
    height = getProperty(node, "height")
    widget.height = height
    widget.setRect = Search_setRect
    widget.measureWidth = dummy_measureWidth
    widget.measureHeight = dummy_measureHeight
    div.style.background = "white"
    div.style.border = "solid 1px " + DarkBackground
    widget.clear = function() { clearSearch(widget) }
    widget.getValue = Search_getValue
    widget.focus = Search_focus
    input = make(div, "input")
    input.type = "text"
    input.style.outline = "none"
    input.style.background = "white"
    input.style.border = "none"
    input.style.padding = "2px"
    addTooltip(input, node.tooltip)
    //input.className = "mousetrap"
    widget.input = input
    bindEventInternal(
        input,
        "input",
        widget,
        onSearchButtonInput
    )
    bindEventInternal(
        input,
        "keydown",
        widget,
        onSearchButtonKeyPress
    )
    img = make(div, "img")
    img.width = height
    img.height = height
    img.style.display = "inline-block"
    img.draggable = false
    widget.button = img
    bindEventInternal(
        img,
        "click",
        widget,
        onSearchButtonClick
    )
    setSearchIcon(widget)
}

function createSplitter(div, node, widget) {
    var border, dummy, left, leftOverlay, leftSplitter, linkFields, middle, right, rightOverlay, rightSplitter
    gWidgets.createLink(
        "widgets",
        "leftChild",
        "widgets",
        "p2",
        "simple"
    )
    gWidgets.createLink(
        "widgets",
        "rightChild",
        "widgets",
        "p2",
        "simple"
    )
    gWidgets.createLink(
        "widgets",
        "middleChild",
        "widgets",
        "p2",
        "simple"
    )
    linkFields = [
    	"leftChild",
    	"rightChild",
    	"middleChild"
    ]
    disconnectOnDestruct(
        widget,
        linkFields
    )
    left = getProperty(node, "leftChild")
    middle = getProperty(node, "middleChild")
    right = getProperty(node, "rightChild")
    widget.splitterWidth = node.splitterWidth || 6
    widget.left = node.left || 200
    widget.right = node.right || 200
    widget.leftVisible = getPropertyOr(
    	node,
    	"leftVisible",
    	true
    )
    widget.rightVisible = getPropertyOr(
    	node,
    	"rightVisible",
    	true
    )
    widget.overlayWidth = getPropertyOr(
    	node,
    	"overlayWidth",
    	20
    )
    widget.overShift = getPropertyOr(
    	node,
    	"overShift",
    	5
    )
    connect(
        widget,
        "leftChild",
        createWidgetUnder(div, left, widget)
    )
    connect(
        widget,
        "middleChild",
        createWidgetUnder(div, middle, widget)
    )
    connect(
        widget,
        "rightChild",
        createWidgetUnder(div, right, widget)
    )
    leftSplitter = make(div, "div")
    rightSplitter = make(div, "div")
    leftOverlay = make(div, "div")
    rightOverlay = make(div, "div")
    dummy = make(div, "div")
    widget.leftSplitter  = leftSplitter 
    widget.rightSplitter  = rightSplitter 
    widget.leftOverlay  = leftOverlay 
    widget.rightOverlay  = rightOverlay 
    widget.dummy  = dummy
    dummy.style.display = "none"
    leftOverlay.style.zIndex = 10
    rightOverlay.style.zIndex = 10
    leftOverlay.className = "dumb"
    rightOverlay.className = "dumb"
    dummy.style.zIndex = 5
    dummy.style.background = "#5090ff"
    dummy.style.border = "solid 1px black"
    border = "solid 1px " + DarkBackground
    leftSplitter.style.background = DarkBackground
    rightSplitter.style.background = DarkBackground
    leftSplitter.style.borderLeft = border
    leftSplitter.style.borderRight = border
    rightSplitter.style.borderLeft = border
    rightSplitter.style.borderRight = border
    leftOverlay.style.cursor = "ew-resize"
    rightOverlay.style.cursor = "ew-resize"
    //leftOverlay.style.background = "green"
    //leftOverlay.style.opacity = 0.3
    //rightOverlay.style.background = "blue"
    //rightOverlay.style.opacity = 0.3
    bindEventInternal(
        leftOverlay,
        "mousedown",
        widget,
        onLeftSplitterDown
    )
    bindEventInternal(
        leftOverlay,
        "mousemove",
        widget,
        onSplitterMove
    )
    bindEventInternal(
        leftOverlay,
        "mouseout",
        widget,
        onSplitterUp
    )
    bindEventInternal(
        leftOverlay,
        "mouseup",
        widget,
        onSplitterUp
    )
    bindEventInternal(
        rightOverlay,
        "mousedown",
        widget,
        onRightSplitterDown
    )
    bindEventInternal(
        rightOverlay,
        "mousemove",
        widget,
        onSplitterMove
    )
    bindEventInternal(
        rightOverlay,
        "mouseout",
        widget,
        onSplitterUp
    )
    bindEventInternal(
        rightOverlay,
        "mouseup",
        widget,
        onSplitterUp
    )
    bindEventInternal(
        leftOverlay,
        "touchstart",
        widget,
        wrapTouch(onLeftSplitterDown)
    )
    bindEventInternal(
        leftOverlay,
        "touchmove",
        widget,
        onSplitterTouchMove
    )
    bindEventInternal(
        leftOverlay,
        "touchend",
        widget,
        onSplitterUp
    )
    bindEventInternal(
        leftOverlay,
        "touchcancel",
        widget,
        onSplitterUp
    )
    bindEventInternal(
        rightOverlay,
        "touchstart",
        widget,
        wrapTouch(onRightSplitterDown)
    )
    bindEventInternal(
        rightOverlay,
        "touchmove",
        widget,
        onSplitterTouchMove
    )
    bindEventInternal(
        rightOverlay,
        "touchend",
        widget,
        onSplitterUp
    )
    bindEventInternal(
        rightOverlay,
        "touchcancel",
        widget,
        onSplitterUp
    )
    widget.setRect = resizeSplitter
}

function createTextButton(div, node, widget) {
    var text
    div.className = "common_button"
    widget.customWidth = node.customWidth || 0
    noContext(div)
    div.style.textAlign = "center"
    copyStyle(node, div)
    copyClass(node, div)
    text = getProperty(node, "text")
    if (node.raw) {
        
    } else {
        text = translate(text)
    }
    HtmlUtils.setDivText(div, text)
    widget.setRect = default_setRect
    widget.measureWidth = TextButton_measureWidth
    widget.enable = TextButton_enable
    addTooltip(div, node.tooltip)
    bindEvent(
        div,
        "click",
        node.id,
        null,
        null,
        true
    )
}

function createTreeNode(widget, parentDiv, item) {
    var icon, left, onPlus, plus, plusImg, textPart
    item.div = make(parentDiv, "div")
    item.myDiv = make(item.div, "div")
    item.kidsDiv = make(item.div, "div")
    item.myDiv.className = "list_item"
    item.myDiv.display = "inline-block"
    item.myDiv.style.paddingLeft = (item.depth *
      TreeIconWidth) + "px"
    bindEvent(
        item.myDiv,
        "click",
        widget.id,
        item.id,
        null,
        false
    )
    bindOnContext(
        item.myDiv,
        widget.id,
        item.id,
        null
    )
    if (item.isFolder) {
        plusImg = makeImg(
            item.myDiv,
            "plus-collapse.png",
            TreeIconWidth,
            TreeIconWidth
        )
        plusImg.style.verticalAlign = "middle"
        item.plusDiv = plusImg
        onPlus = function(evt, w) {
            onPlusClick(
                evt,
                w,
                item.id
            )
        }
        plusImg.style.cursor = "default"
        bindEventInternal(
            plusImg,
            "click",
            widget,
            onPlus
        )
    } else {
        plus = makeIB(item.myDiv)
        plus.style.width = TreeIconWidth + "px"
    }
    icon = makeImg(
        item.myDiv,
        item.icon,
        TreeIconWidth,
        TreeIconWidth
    )
    icon.style.verticalAlign = "middle"
    item.iconDiv = icon
    textPart = makeIB(item.myDiv)
    textPart.style.padding = "8px"
    item.textDiv = textPart
    HtmlUtils.setDivText(textPart, item.text)
    left = (item.depth + 2) * TreeIconWidth
}

function createTreeNodeItem(widget, parent, id, isFolder, icon, text, rank) {
    var depth, item, parentItem
    depth = 0
    if (parent) {
        parentItem = getTreeItem(widget, parent)
        depth = parentItem.depth + 1
    }
    item = {
        parent : parent,
        isFolder : isFolder,
        icon : icon,
        text : text,
        rank : rank,
        depth : depth
    }
    widget.items.insert(
        "items",
        id,
        item
    )
    return getTreeItem(widget, id)
}

function createTreeView(div, node, widget) {
    widget.setRect = default_setRect
    widget.clear = tree_clear
    widget.setIcon = tree_setIcon
    widget.setText = tree_setText
    widget.setChildren = tree_setChildren
    widget.removeChildren = tree_removeChildren
    widget.select = tree_select
    widget.deselect = tree_deselect
    widget.expand = tree_expand
    widget.collapse = tree_collapse
    widget.remove = tree_remove
    widget.rename = tree_rename
    widget.mark = tree_mark
    widget.getParent = tree_getParent
    widget.hasItem = tree_hasItem
    widget.scrollIntoView = tree_scrollIntoView
    widget.getItem = tree_getItem
    widget.div = div
    resetTreeData(widget)
    copyStyle(node, div)
    div.style.overflowY = "auto"
    div.style.overflowX = "hidden"
    div.style.whiteSpace = "nowrap"
    createTreeViewRoot(widget)
    bindOnContext(
        div,
        widget.id,
        null,
        null
    )
}

function createTreeViewRoot(widget) {
    var rootItem
    rootItem = createTreeNodeItem(
        widget,
        null,
        "<root>",
        true,
        "none",
        "<root>",
        0
    )
    widget.root = rootItem.id
    rootItem.kidsDiv = widget.div
    rootItem.expanded = true
    rootItem.depth = -1
}

function createVDock(div, node, widget) {
    var centerNode, topNode
    gWidgets.createLink(
        "widgets",
        "top",
        "widgets",
        "p2",
        "simple"
    )
    gWidgets.createLink(
        "widgets",
        "center",
        "widgets",
        "p2",
        "simple"
    )
    disconnectOnDestruct(
        widget,
        ["center", "top"]
    )
    topNode = getProperty(node, "top")
    centerNode = getProperty(node, "center")
    connect(
        widget,
        "top",
        createWidgetUnder(div, topNode, widget)
    )
    connect(
        widget,
        "center",
        createWidgetUnder(div, centerNode, widget)
    )
    widget.setRect = VDock_setRect
    widget.measureHeight = VDock_measureHeight
}

function createVPanel(div, node, widget) {
    var kids
    kids = getProperty(node, "kids")
    widget.width = node.width
    var _ind2374 = 0;
    var _col2374 = kids;
    var _len2374 = _col2374.length;
    while (true) {
        if (_ind2374 < _len2374) {
            
        } else {
            break;
        }
        var childNode = _col2374[_ind2374];
        createWidgetUnder(div, childNode, widget)
        _ind2374++;
    }
    widget.setRect = VPanel_setRect
    widget.measureHeight = VPanel_measureHeight
    widget.measureWidth = VPanel_measureWidth
}

function createWLabel(div, node, widget) {
    var align, text, textId
    align = node.textAlign || "left"
    div.style.textAlign = align
    //div.style.padding = "8px"
    div.style.textAlign = "left"
    div.style.lineHeight = "120%"
    div.style.whiteSpace = "normal"
    div.style.width = "100%"
    copyStyle(node, div)
    textId = getProperty(node, "text")
    if (node.raw) {
        text = textId
    } else {
        text = translate(textId)
    }
    HtmlUtils.setDivText(div, text)
    widget.text = text
    widget.div = div
    widget.setRect = default_setRect
    widget.measureHeight = WTextButton_measureHeight
}

function createWTextButton(div, node, widget) {
    var text
    div.className = "common_button"
    widget.padding = node.padding || 10
    div.style.padding = widget.padding + "px"
    div.style.borderRadius = "5px"
    noContext(div)
    div.style.textAlign = "center"
    div.style.lineHeight = "120%"
    div.style.whiteSpace = "normal"
    copyStyle(node, div)
    copyClass(node, div)
    text = translate(getProperty(node, "text"))
    HtmlUtils.setDivText(div, text)
    widget.setRect = default_setRect
    widget.measureHeight = WTextButton_measureHeight
    addTooltip(div, node.tooltip)
    bindEvent(
        div,
        "click",
        node.id,
        null,
        null,
        true
    )
}

function createWidget(parentDiv, node) {
    var div, fields, generator, nodeCopy, widget
    if (node.type) {
        generator = gGenerators[node.type]
        if (isUndefined(generator)) {
            raise("Unknown widget type: \"" + 
            	node.type + "\"")
        } else {
            nodeCopy = Utils.copyObject(node)
            fields = {
                signalId : nodeCopy.signalId,
                type : nodeCopy.type
            }
            widget = gWidgets.insert(
                "widgets",
                nodeCopy.id,
                fields
            )
            if (widget.signalId) {
                
            } else {
                widget.signalId = widget.id
            }
            div = make(parentDiv, "div")
            div.id = widget.id
            nodeCopy.id = widget.id
            generator(div, nodeCopy, widget)
            return widget.id
        }
    } else {
        raise("\"type\" property is missing in node")
    }
}

function createWidgetUnder(parentDiv, node, parent) {
    var id
    id = createWidget(
        parentDiv,
        node
    )
    gWidgets.update(
        "widgets",
        id,
        {parent:parent.id}
    )
    return getWidget(id)
}

function darkLine() {
    return  "1px solid " + DarkBackground
}

function defaultWrap(action) {
    return action
}

function default_setRect() {
    setWidgetDiv(this)
}

function deleteDiv(div) {
    if ((div) && (div.parentNode)) {
        div.parentNode.removeChild(div)
    }
}

function deleteWidget(id) {
    var element, kids, widget
    element = document.getElementById(id)
    if (element) {
        deleteDiv(element)
    }
    widget = getWidget(id)
    kids = copyArray(widget.kids)
    destruct(widget)
    var _ind2346 = 0;
    var _col2346 = kids;
    var _len2346 = _col2346.length;
    while (true) {
        if (_ind2346 < _len2346) {
            
        } else {
            break;
        }
        var kid = _col2346[_ind2346];
        deleteWidget(kid.id)
        _ind2346++;
    }
    gWidgets.remove("widgets", id)
}

function destruct(widget) {
    if (widget.destructor) {
        widget.destructor()
    }
}

function disconnect(widget, field) {
    gWidgets.set(
        "widgets",
        widget.id,
        field,
        null
    )
}

function disconnectMany(widget, fields) {
    var _ind4074 = 0;
    var _col4074 = fields;
    var _len4074 = _col4074.length;
    while (true) {
        if (_ind4074 < _len4074) {
            
        } else {
            break;
        }
        var field = _col4074[_ind4074];
        disconnect(widget, field)
        _ind4074++;
    }
}

function disconnectOnDestruct(widget, fields) {
    widget.destructor = function() {
        disconnectMany(
            widget,
            fields
        )
    }
}

function display(id, value) {
    var element
    element = get(id)
    element.style.display = value
}

function divIBlock(div) {
    div.style.display = "inline-block"
}

function dummy_measureHeight(width) {
    if ("height" in this) {
        return this.height
    } else {
        raise("dummy_measureHeight: height not specified")
    }
}

function dummy_measureWidth(height) {
    if ("width" in this) {
        return this.width
    } else {
        raise("dummy_measureWidth: width not specified")
    }
}

function findChild(widget, id) {
    var i, kids
    kids = widget.kids
    i = 0;
    while (true) {
        if (i < kids.length) {
            
        } else {
            return -1
        }
        if (kids[i].id == id) {
            return i
        }
        i++;
    }
}

function fireEvent(evt, type, widgetId, rowId, cellId, stopProcessing) {
    var action, wrapped
    action = function() {
        fireEventCore(
            evt,
            type,
            widgetId,
            rowId,
            cellId,
            stopProcessing
        )
    }
    wrapped = self.wrapException(action)
    wrapped()
}

function fireEventCore(evt, type, widgetId, rowId, cellId, stopProcessing) {
    var widget
    widget = getWidget(widgetId)
    self.onEvent(
        evt,
        type,
        widget,
        rowId,
        cellId
    )
    if ((stopProcessing) && (evt.stopPropagation)) {
        evt.stopPropagation()
    }
}

function foreach(visit) {
    var state
    state = gWidgets.getState()
    var _ind3845 = 0;
    var _col3845 = state.widgets;
    var _keys3845 = Object.keys(_col3845); 
    var _len3845 = _keys3845.length;
    while (true) {
        if (_ind3845 < _len3845) {
            
        } else {
            break;
        }
        var id = _keys3845[_ind3845]; var widget = _col3845[id];
        visit(widget)
        _ind3845++;
    }
}

function get(id) {
    var element
    element = document.getElementById(id)
    if (element) {
        return element
    } else {
        throw Error("get: element '" + id + "' not found")
    }
}

function getItemOrdinal(items, id) {
    var i, item, result
    result = -1
    i = 0;
    while (true) {
        if (i < items.length) {
            
        } else {
            break;
        }
        item = items[i]
        if (item.id == id) {
            result = i
            break;
        }
        i++;
    }
    return result
}

function getLocalCoords(element, evt) {
    var rect
    rect = element.getBoundingClientRect()
    return {
        x : evt.clientX - rect.left,
        y : evt.clientY - rect.top
    }
}

function getProperty(node, name) {
    var value
    value = node[name]
    if (value) {
        return value
    } else {
        raise("Missing property \"" +
          name + "\" for \"" + node.type + "\", id: " +
          node.id)
    }
}

function getPropertyOr(node, name, defaultValue) {
    if (name in node) {
        return node[name]
    } else {
        return defaultValue
    }
}

function getTreeItem(widget, id) {
    return widget.items.get("items", id)
}

function getTreeItems(widget) {
    var items
    items = widget.items.getState().items
    return items
}

function getWidget(id) {
    return gWidgets.get("widgets", id)
}

function hideDiv(div) {
    div.style.display = "none"
}

function hideWidget(id) {
    var div
    div = get(id)
    div.style.display = "none"
}

function init() {
    gGenerators.dummy = createDummy
    gGenerators.vdock = createVDock
    gGenerators.vpanel = createVPanel
    gGenerators.hdock = createHDock
    gGenerators.text_button = createTextButton
    gGenerators.image_button = createImageButton
    gGenerators.page = createPage
    gGenerators.list = createList
    gGenerators.list_grid = createListGrid
    gGenerators.tree = createTreeView
    gGenerators.many = createMany
    gGenerators.label = createLabel
    gGenerators.pane = createPane
    gGenerators.check = createCheck
    gGenerators.search = createSearch
    gGenerators.wbutton = createWTextButton
    gGenerators.wlabel = createWLabel
    gGenerators.custom = createCustom
    gGenerators.edit = createEditBox
    gGenerators.splitter = createSplitter
    gGenerators.path = createPath
    gGenerators.multi_pane = createMultipane
    gWidgets.createTable("widgets")
    gWidgets.createLink(
        "widgets",
        "parent",
        "widgets",
        "kids",
        "list"
    )
}

function isUndefined(obj) {
    return (typeof obj == "undefined")
}

function make(parent, tag) {
    var element
    element = document.createElement(tag)
    parent.appendChild(element)
    //element.ontouchstart = prevent
    //element.ontouchmove = prevent
    //element.ontouchend = prevent
    return element
}

function makeCellId(rowId, id) {
    return rowId + "_" + id
}

function makeFullScreen(div) {
    var style
    style = div.style
    style.width = null
    style.display = "inline-block"
    style.position = "absolute"
    style.left = "0px"
    style.top = "0px"
    style.right = "0px"
    style.bottom = "0px"
    //style.background = "rgba(1, 0, 0, 0.5)"
}

function makeIB(parent) {
    var div
    div = make(parent, "div")
    div.style.display = "inline-block"
    return div
}

function makeImagePath(image) {
    return self.imagePath + image
}

function makeImagePathUrl(image) {
    var path
    path = makeImagePath(image)
    return "url('" + path + "')"
}

function makeImg(parent, src, width, height) {
    var img
    img = make(parent, "img")
    img.src = makeImagePath(src)
    img.width = width
    img.height = height
    img.draggable = false
    return img
}

function makeInnerId(widget) {
    return widget.id + "_inner"
}

function makeInternalButtonStyle(div) {
    div.className = "internal_button common_button"
}

function makeItemId(widgetId, id) {
    return widgetId + "_item_" + id
}

function makeListId(id) {
    return id + "_list"
}

function makeNoItemsId(id) {
    return id + "_noItems"
}

function noContext(div) {
    HtmlUtils.noContext(div)
}

function onCheckClick(evt, widget) {
    widget.isChecked = !widget.isChecked
    setCheckboxImage(widget)
    fireEvent(
        evt,
        "check",
        widget.id,
        null,
        null,
        true
    )
}

function onLeftSplitterDown(evt, widget) {
    startResizeSplitter(widget, evt, true)
}

function onPaneChange(widgetId, value) {
    var manyId, multi, widget
    multi = getWidget(widgetId)
    multi.active = value
    manyId = Multipane_makeManyId(widgetId)
    widget = getWidget(manyId)
    widget.setActive(value)
    if (multi.rect) {
        multi.setRect()
    }
}

function onPlusClick(evt, widget, itemId) {
    var item
    HtmlUtils.stopPropagation(evt)
    item = getTreeItem(widget, itemId)
    if (item.expanded) {
        widget.collapse(itemId)
        fireEventCore(
            evt,
            "collapse",
            widget.id,
            itemId,
            null,
            false
        )
    } else {
        widget.expand(itemId)
        fireEventCore(
            evt,
            "expand",
            widget.id,
            itemId,
            null,
            false
        )
    }
}

function onRightSplitterDown(evt, widget) {
    startResizeSplitter(widget, evt, false)
}

function onSearchButtonClick(evt, widget) {
    if (widget.input.value) {
        clearSearch(widget)
        fireEvent(
            evt,
            "input",
            widget.id,
            null,
            null,
            true
        )
    }
}

function onSearchButtonInput(evt, widget) {
    setSearchIcon(widget)
    fireEvent(
        evt,
        "input",
        widget.id,
        null,
        null,
        true
    )
}

function onSearchButtonKeyPress(evt, widget) {
    if ((evt.key == "Escape") || (evt.keyCode == 27)) {
        HtmlUtils.preventDefaultHandling(evt)
        widget.clear()
        fireEvent(
            evt,
            "escape",
            widget.id,
            null,
            null,
            true
        )
    }
}

function onSplitterMove(evt, widget) {
    var box, current, div, local, thickness, width
    if (widget.dragging) {
        box = widget.rect
        div = get(widget.id)
        local = getLocalCoords(div, evt)
        current = local.x + widget.shift
        width = box.width
        thickness = widget.splitterWidth
        current = Math.max(current, thickness)
        current = Math.min(current, width - thickness * 1.5)
        widget.current = current
        positionSplitterDummy(widget)
    }
}

function onSplitterTouchMove(evt, widget) {
    var mevt
    mevt = HtmlUtils.touchToMouse(evt)
    evt.preventDefault()
    onSplitterMove(mevt, widget)
}

function onSplitterUp(evt, widget) {
    var box, current
    if (widget.dragging) {
        widget.dragging = false
        box = widget.rect
        current = widget.current
        if (widget.isLeft) {
            widget.left = current
        } else {
            widget.right = box.width - current
        }
        hideDiv(widget.dummy)
        widget.setRect()
        fireEvent(
        	evt,
        	"resize",
        	widget.id,
        	null,
        	null,
        	false
        )
    }
}

function positionSplitterDummy(widget) {
    var box, height, thickness
    box = widget.rect
    height = box.height
    thickness = widget.splitterWidth
    setPos(
        widget.dummy,
        widget.current - thickness / 2,
        0,
        thickness,
        height - 2
    )
}

function raise(text) {
    throw new Error(text)
}

function removeAt(array, index) {
    array.splice(index, 1)
}

function removeNode(widget, item) {
    var kids
    kids = copyArray(item.kids)
    var _ind3238 = 0;
    var _col3238 = kids;
    var _len3238 = _col3238.length;
    while (true) {
        if (_ind3238 < _len3238) {
            
        } else {
            break;
        }
        var kid = _col3238[_ind3238];
        removeNode(widget, kid)
        _ind3238++;
    }
    deleteDiv(item.div)
    widget.items.remove(
        "items",
        item.id
    )
}

function resetTreeData(widget) {
    widget.items = new TabGen4()
    widget.items.createTable("items")
    widget.items.createLink(
        "items",
        "parent",
        "items",
        "kids",
        "list"
    )
}

function resizeSplitter() {
    var MIN_MIDDLE, box, centralWidth, height, left, leftThick, middle, overShift, overThick, px, py, right, rightThick, thickness, width, x1
    setWidgetDiv(this)
    overShift = this.overShift
    box = this.rect
    py = 0
    px = 0
    width = box.width
    height = box.height
    thickness = this.splitterWidth
    overThick = this.overlayWidth
    left = this.left
    right = this.right
    centralWidth = width - left - right -
      2 * thickness
    leftThick = thickness
    rightThick = thickness
    if (this.leftVisible) {
        
    } else {
        left = 0
        leftThick = 0
    }
    if (this.rightVisible) {
        
    } else {
        right = 0
        rightThick = 0
    }
    middle = width - right - left -
     leftThick/2 - rightThick/2
    MIN_MIDDLE = 10
    if (middle >= MIN_MIDDLE) {
        
    } else {
        if (right == 0) {
            if (left == 0) {
                middle = MIN_MIDDLE
            } else {
                left = width - right - MIN_MIDDLE -
                  leftThick - rightThick
                if (left >= thickness) {
                    middle = width - right - left -
                      leftThick/2 - rightThick/2
                    this.left = left
                    this.right = right
                } else {
                    left = thickness
                    middle = MIN_MIDDLE
                }
            }
        } else {
            right = width - left - rightThick - leftThick
            if (right >= thickness * 1.5) {
                middle = width - right - left -
                  leftThick/2 - rightThick/2
                this.left = left
                this.right = right
            } else {
                right = thickness * 1.5
                if (left == 0) {
                    middle = MIN_MIDDLE
                } else {
                    left = width - right - MIN_MIDDLE -
                      leftThick - rightThick
                    if (left >= thickness) {
                        middle = width - right - left -
                          leftThick/2 - rightThick/2
                        this.left = left
                        this.right = right
                    } else {
                        left = thickness
                        middle = MIN_MIDDLE
                    }
                }
            }
        }
    }
    if (left == 0) {
        hideWidget(this.leftChild.id)
        hideDiv(this.leftSplitter)
        hideDiv(this.leftOverlay)
    } else {
        showWidget(this.leftChild.id)
        divIBlock(this.leftSplitter)
        divIBlock(this.leftOverlay)
        resizeWidget(
            this.leftChild.id,
            px,
            py,
            left - thickness / 2,
            height
        )
        setPos(
            this.leftSplitter,
            px + left - thickness / 2,
            py,
            thickness,
            height
        )
        setPos(
            this.leftOverlay,
            px + left - overThick / 2 + overShift,
            py,
            overThick,
            height
        )
    }
    x1 = px + width
    if (right == 0) {
        hideWidget(this.rightChild.id)
        hideDiv(this.rightSplitter)
        hideDiv(this.rightOverlay)
    } else {
        showWidget(this.rightChild.id)
        divIBlock(this.rightSplitter)
        divIBlock(this.rightOverlay)
        resizeWidget(
            this.rightChild.id,
            x1 - right + thickness / 2,
            py,
            right - thickness / 2,
            height
        )
        setPos(
            this.rightSplitter,
            x1 - right - thickness / 2,
            py,
            thickness,
            height
        )
        setPos(
            this.rightOverlay,
            x1 - right - overThick / 2 + overShift,
            py,
            overThick,
            height
        )
    }
    resizeWidget(
        this.middleChild.id,
        px + left + leftThick / 2,
        py,
        middle,
        height
    )
}

function resizeWidget(id, left, top, width, height) {
    var widget
    widget = getWidget(id)
    setRect(
        widget,
        left,
        top,
        width,
        height
    )
}

function scheduleEvent(evt, type, widgetId, rowId, cellId) {
    var action
    action = function() {
        fireEvent(
            evt,
            type,
            widgetId,
            rowId,
            cellId,
            false
        )
    }
    window.setTimeout(action, 10)
}

function setCheckboxImage(widget) {
    var image, style, url
    style = get(widget.id).style
    if (widget.isChecked) {
        image = "checked.png"
    } else {
        image = "unchecked.png"
    }
    url = makeImagePathUrl(image)
    style.backgroundImage = url
}

function setHeight(div, height) {
    var bottomBorder, bottomPadding, height2, style, topBorder, topPadding
    style = div.style
    topPadding = stripPx(style.paddingTop)
    bottomPadding = stripPx(style.paddingBottom)
    topBorder = stripPx(style.borderTopWidth)
    bottomBorder = stripPx(style.borderBottomWidth)
    height2 = height - topPadding - bottomPadding -
      topBorder - bottomBorder
    style.height = height2 + "px"
}

function setListRowFormat(row) {
    var style
    row.className = "list_item"
    style = row.style
    //style.whiteSpace = "nowrap"
    //style.height = "18px"
    style.padding = "6px"
    style.borderBottom = "solid 1px silver"
    style.lineHeight = "120%"
}

function setPos(div, left, top, width, height) {
    var style
    style = div.style
    style.display = "inline-block"
    style.position = "absolute"
    style.left = left + "px"
    style.top = top + "px"
    setWidth(div, width)
    setHeight(div, height)
}

function setRect(widget, left, top, width, height) {
    widget.rect = {
        left : left,
        top : top,
        width : width,
        height : height
    }
    widget.setRect()
}

function setSearchIcon(widget) {
    var img, value
    img = widget.button
    value = widget.input.value
    value = value.trim()
    if (value) {
        img.src = makeImagePath("backspace.png")
        img.style.cursor = "pointer"
    } else {
        img.src = makeImagePath("search-s.png")
        img.style.cursor = "default"
    }
}

function setWidgetDiv(widget) {
    var div, height, left, rect, top, width
    rect = widget.rect
    left = rect.left
    top = rect.top
    width = rect.width
    height = rect.height
    div = get(widget.id)
    setPos(
        div,
        left,
        top,
        width,
        height
    )
}

function setWidth(div, width) {
    var leftBorder, leftPadding, rightBorder, rightPadding, style, width2
    style = div.style
    leftPadding = stripPx(style.paddingLeft)
    rightPadding = stripPx(style.paddingRight)
    leftBorder = stripPx(style.borderLeftWidth)
    rightBorder = stripPx(style.borderRightWidth)
    width2 = width - leftPadding -
      rightPadding - leftBorder - 
      rightBorder
    style.width = width2 + "px"
}

function showWidget(id) {
    var div
    div = get(id)
    div.style.display = "inline-block"
}

function startResizeSplitter(widget, evt, isLeft) {
    var box, div, local, old
    div = get(widget.id)
    local = getLocalCoords(div, evt)
    widget.isLeft = isLeft
    widget.dragging = true
    divIBlock(widget.dummy)
    box = widget.rect
    if (isLeft) {
        old = widget.left
        makeFullScreen(widget.leftOverlay)
        hideDiv(widget.rightOverlay)
    } else {
        old = box.width - widget.right
        makeFullScreen(widget.rightOverlay)
        hideDiv(widget.leftOverlay)
    }
    widget.current = old
    widget.shift = old - local.x
    positionSplitterDummy(widget)
}

function stripPx(value) {
    var noPx
    if ((value) && (!(value == "initial"))) {
        if (value == "medium") {
            return 1
        } else {
            noPx = value.substring(0, value.length - 2)
            value = parseFloat(noPx)
            if (isNaN(value)) {
                return 0
            } else {
                return value
            }
        }
    } else {
        return 0
    }
}

function tree_clear() {
    var div
    div = this.div()
    div.innerHTML = ""
    resetTreeData(this)
}

function tree_collapse(itemId) {
    var item
    item = getTreeItem(this, itemId)
    if (item.expanded) {
        item.plusDiv.src = makeImagePath(
            "plus-collapse.png"
        )
        item.expanded = false
        clearDiv(item.kidsDiv)
    }
}

function tree_deselect() {
    var items
    items = getTreeItems(this)
    var _ind3101 = 0;
    var _col3101 = items;
    var _keys3101 = Object.keys(_col3101); 
    var _len3101 = _keys3101.length;
    while (true) {
        if (_ind3101 < _len3101) {
            
        } else {
            break;
        }
        var currentId = _keys3101[_ind3101]; var item = _col3101[currentId];
        if (item.myDiv) {
            item.myDiv.style.background = ""
            item.myDiv.style.color = ""
            item.myDiv.className = "list_item"
        }
        _ind3101++;
    }
}

function tree_expand(itemId) {
    var item
    item = getTreeItem(this, itemId)
    if (item.expanded) {
        
    } else {
        item.plusDiv.src = makeImagePath(
            "plus-expand.png"
        )
        item.expanded = true
        var _ind3116 = 0;
        var _col3116 = item.kids;
        var _len3116 = _col3116.length;
        while (true) {
            if (_ind3116 < _len3116) {
                
            } else {
                break;
            }
            var kid = _col3116[_ind3116];
            createTreeNode(
            	this,
            	item.kidsDiv,
            	kid
            )
            _ind3116++;
        }
    }
}

function tree_getItem(id) {
    return getTreeItem(this, id)
}

function tree_getParent(id) {
    var item
    item = getTreeItem(this, id)
    return item.parent.id
}

function tree_hasItem(id) {
    var items
    items = getTreeItems(this)
    if (id in items) {
        return true
    } else {
        return false
    }
}

function tree_mark(id) {
    var items
    items = getTreeItems(this)
    var _ind3154 = 0;
    var _col3154 = items;
    var _keys3154 = Object.keys(_col3154); 
    var _len3154 = _keys3154.length;
    while (true) {
        if (_ind3154 < _len3154) {
            
        } else {
            break;
        }
        var currentId = _keys3154[_ind3154]; var item = _col3154[currentId];
        if (item.myDiv) {
            if (currentId == id) {
                item.myDiv.className = "list_item_marked"
            } else {
                item.myDiv.className = "list_item"
            }
        }
        _ind3154++;
    }
}

function tree_remove(id) {
    var item
    item = this.items.getRowOrNull(
        "items",
        id
    )
    if (item) {
        removeNode(this, item)
    }
}

function tree_removeChildren(id) {
    var kids, parent
    id = id || this.root
    parent = getTreeItem(this, id)
    clearDiv(parent.kidsDiv)
    kids = copyArray(parent.kids)
    var _ind3068 = 0;
    var _col3068 = kids;
    var _len3068 = _col3068.length;
    while (true) {
        if (_ind3068 < _len3068) {
            
        } else {
            break;
        }
        var kid = _col3068[_ind3068];
        removeNode(this, kid)
        _ind3068++;
    }
}

function tree_rename(id, name) {
    var item
    item = getTreeItem(this, id)
    item.text = name
    if (item.textDiv) {
        HtmlUtils.setDivText(item.textDiv, name)
    }
}

function tree_scrollIntoView(id) {
    var div, item, parent
    item = getTreeItem(this, id)
    div = item.div
    parent = get(this.id)
    HtmlUtils.scrollIntoViewCore(
        parent,
        div
    )
}

function tree_select(id) {
    var items
    this.deselect()
    items = getTreeItems(this)
    var _ind3089 = 0;
    var _col3089 = items;
    var _keys3089 = Object.keys(_col3089); 
    var _len3089 = _keys3089.length;
    while (true) {
        if (_ind3089 < _len3089) {
            
        } else {
            break;
        }
        var currentId = _keys3089[_ind3089]; var item = _col3089[currentId];
        if ((item.myDiv) && (currentId == id)) {
            item.myDiv.style.background = DarkBackground
            item.myDiv.style.color = "white"
        }
        _ind3089++;
    }
}

function tree_setChildren(parentId, kids) {
    var parent
    parentId = parentId || this.root
    parent = getTreeItem(this, parentId)
    this.removeChildren(parentId)
    var _ind3193 = 0;
    var _col3193 = kids;
    var _len3193 = _col3193.length;
    while (true) {
        if (_ind3193 < _len3193) {
            
        } else {
            break;
        }
        var kidInfo = _col3193[_ind3193];
        createTreeNodeItem(
            this,
            parentId,
            kidInfo.id,
            kidInfo.isFolder || false,
            kidInfo.icon,
            kidInfo.text,
            kidInfo.rank
        )
        _ind3193++;
    }
    kids = parent.kids
    kids.sort(compareTreeItems)
    var _ind3208 = 0;
    var _col3208 = kids;
    var _len3208 = _col3208.length;
    while (true) {
        if (_ind3208 < _len3208) {
            
        } else {
            break;
        }
        var kid = _col3208[_ind3208];
        if (parent.expanded) {
            createTreeNode(
                this,
                parent.kidsDiv,
                kid
            )
        }
        _ind3208++;
    }
}

function tree_setIcon(id, image) {
    var item
    item = getTreeItem(this, id)
    if (item.iconDiv) {
        item.iconDiv.src = makeImagePath(image)
    }
}

function tree_setText(id, text) {
    var div, item, items
    items = getTreeItems(this)
    if (id in items) {
        item = items[id]
        div = item.textDiv
        HtmlUtils.setDivText(div, text)
    }
}

function uncheckItem(widget, i) {
    var cell, cellId, id, image, img, item, rowId
    item = widget.items[i]
    id = item.id
    cell = item.cells[0]
    image = cell.src
    rowId = makeItemId(widget.id, id)
    cellId = makeCellId(rowId, "0")
    img = get(cellId)
    img.src = makeImagePath(image)
    item.checked = false
}

function wrapTouch(action) {
    var mevt
    return function(evt, widget) {
    	mevt = HtmlUtils.touchToMouse(evt)
    	evt.preventDefault()
    	action(mevt, widget)
    }
}


this.wrapException = defaultWrap
this.onEvent = function() {}
this.getToolTip = function() { return gToolTip }

init()

this.createWidget = createWidget
this.getWidget = getWidget
this.resizeWidget = resizeWidget
this.deleteWidget = deleteWidget
this.foreach = foreach

}
