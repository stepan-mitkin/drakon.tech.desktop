function Behaviour(
	editor,
	canvas,
	view,
	callbacks,
	window,
	context,
	undefined
) {

var LEFT_BUTTON = 0;
var MIDDLE_BUTTON = 1;
var RIGHT_BUTTON = 2;

var cursors = {
	FR_LU: "nwse-resize",
	FR_UP: "ns-resize",
	FR_RU: "nesw-resize",
	FR_RI: "ew-resize",
	FR_RD: "nwse-resize",
	FR_DO: "ns-resize",
	FR_LD: "nesw-resize",
	FR_LE: "ew-resize",
	FR_0: "move",
	FR_1: "move",
	H_EW: "ew-resize"
}


this.draw = draw;
this.redrawCache = redrawCache;
this.setZoom = setZoom;

this.mouseDown = mouseDown;
this.mouseMove = mouseMove;
this.mouseUp = mouseUp;

this.mouseWheel = mouseWheel;

this.touchStart = touchStart;
this.touchEnd = touchEnd;
this.touchMove = touchMove;

this.setTimeout = setTimeout;
this.clearTimeout = clearTimeout;

this.startFreeScroll = startFreeScroll;
this.endFreeScroll = endFreeScroll;

this.finishZoom = finishZoom
this.getBackground = getBackground

this.externalClick = externalClick
this.resetMachines = resetMachines

this.setTransform = setTransform
this.toSelectionMode = toSelectionMode
this.toNormalMode = toNormalMode

// Autogenerated with DRAKON Editor 1.32


function BlockSelector() {
    // item 1006
    this.mouseDown = BlockSelector_mouseDown;
    this.mouseMove = BlockSelector_mouseMove;
    this.mouseUp = BlockSelector_mouseUp;
}

function BlockSelector_mouseDown(message) {
    // item 1012
    this.start = new Utils.Point(message.x, message.y);
    // item 1040
    view.showOver();
    // item 1041
    editor.beginBlockSelect();
    // item 2077
    view.redraw();
}

function BlockSelector_mouseMove(message) {
    // item 1024
    var left, top, right, bottom;
    // item 1025
    var left = Math.min(this.start.x, message.x);
    var right = Math.max(this.start.x, message.x);
    var top = Math.min(this.start.y, message.y);
    var bottom = Math.max(this.start.y, message.y);
    // item 1022
    var block = new Utils.Box(
    	left,
    	top,
    	right,
    	bottom
    );
    // item 1023
    view.selectBlock(block);
    // item 1027
    var mustRedraw = editor.blockSelect(block);
    // item 1028
    if (mustRedraw) {
        // item 1031
        view.redraw();
    }
}

function BlockSelector_mouseUp(message) {
    // item 1038
    view.selectBlock(null);
    // item 1039
    view.hideOver();
}

function DrnSizer(isLeft, id, dims) {
    // item 1259
    this.isLeft = isLeft;
    this.id = id;
    this.dims = dims;
    // item 1260
    this.mouseMove = DrnSizer_mouseMove;
    this.mouseDown = DrnSizer_mouseDown;
    this.mouseUp = DrnSizer_mouseUp;
}

function DrnSizer_mouseDown(evt) {
    // item 1261
    this.start = new Utils.Point(evt.x, evt.y);
    // item 1262
    view.showOver();
}

function DrnSizer_mouseMove(evt) {
    // item 1266
    var dx;
    // item 1267
    if (this.isLeft) {
        // item 1270
        dx = -evt.dx;
    } else {
        // item 1271
        dx = evt.dx;
    }
    // item 1264
    var width = this.dims.w + dx;
    // item 1265
    width = Math.max(
    	width,
    	Config.MIN_ICON_WIDTH
    );
    // item 1272
    this.width = width;
    this.dims.w = width;
    // item 1278
    var dims = this.dims;
    var left = dims.x - width;
    var right = dims.x + width;
    var top = dims.y - dims.h;
    var bottom = dims.y + dims.h;
    // item 1279
    var block = new Utils.Box(
    	left,
    	top,
    	right,
    	bottom
    );
    // item 1280
    view.selectBlock(block);
}

function DrnSizer_mouseUp(evt) {
    // item 1263
    view.hideOver();
    // item 1273
    if (this.width) {
        // item 1276
        editor.setItemWidth(this.id, this.width);
        // item 1422
        evt.handled = true;
        // item 1277
        view.redraw();
    }
}

function FreeScroll_Drag_mouseDown(self, evt) {
    // item 1698
    self.state = "Drag";
}

function FreeScroll_Drag_mouseMove(self, evt) {
    // item 1781
    view.scrollBy(
    	evt.dx,
    	evt.dy
    );
    // item 1777
    self.state = "Drag";
}

function FreeScroll_Drag_mouseUp(self, evt) {
    // item 1756
    self.state = "Idle";
}

function FreeScroll_Idle_mouseDown(self, evt) {
    var _sw16890000_ = 0;
    // item 16890000
    _sw16890000_ = evt.button;
    // item 16890001
    if (_sw16890000_ === LEFT_BUTTON) {
        // item 1674
        self.state = "Drag";
    } else {
        // item 16890002
        if (_sw16890000_ === MIDDLE_BUTTON) {
            // item 1674
            self.state = "Drag";
        } else {
            // item 16890003
            if (_sw16890000_ === RIGHT_BUTTON) {
                // item 1780
                callbacks.click();
            }
            // item 1703
            self.state = "Idle";
        }
    }
}

function FreeScroll_Idle_mouseMove(self, evt) {
    // item 1688
    self.state = "Idle";
}

function FreeScroll_Idle_mouseUp(self, evt) {
    // item 1688
    self.state = "Idle";
}

function FreeSizer(type, id, dims) {
    // item 1829
    this.type = type;
    this.id = id;
    this.dims = dims;
    // item 1830
    this.mouseMove = FreeSizer_mouseMove;
    this.mouseDown = FreeSizer_mouseDown;
    this.mouseUp = FreeSizer_mouseUp;
}

function FreeSizer_mouseDown(evt) {
    // item 1836
    this.start = new Utils.Point(evt.x, evt.y);
    // item 1837
    view.showOver();
}

function FreeSizer_mouseMove(evt) {
    var _sw18670000_ = 0;
    // item 2032
    var ex = evt.dx / 2
    var ey = evt.dy / 2
    var ew = ex
    var eh = ey
    // item 1845
    var dw, dh
    // item 2031
    var dims = this.dims
    // item 18670000
    _sw18670000_ = this.type;
    // item 18670001
    if (_sw18670000_ === "FR_LU") {
        // item 1885
        dx = ex
        dy = ey
        dw = -ew
        dh = -eh
    } else {
        // item 18670002
        if (_sw18670000_ === "FR_UP") {
            // item 1886
            dx = 0
            dy = ey
            dw = 0
            dh = -eh
        } else {
            // item 18670003
            if (_sw18670000_ === "FR_RU") {
                // item 1887
                dx = ex
                dy = ey
                dw = ew
                dh = -eh
            } else {
                // item 18670004
                if (_sw18670000_ === "FR_RI") {
                    // item 2033
                    dx = ex
                    dy = 0
                    dw = ew
                    dh = 0
                } else {
                    // item 18670005
                    if (_sw18670000_ === "FR_RD") {
                        // item 2034
                        dx = ex
                        dy = ey
                        dw = ew
                        dh = eh
                    } else {
                        // item 18670006
                        if (_sw18670000_ === "FR_DO") {
                            // item 1890
                            dx = 0
                            dy = ey
                            dw = 0
                            dh = eh
                        } else {
                            // item 18670007
                            if (_sw18670000_ === "FR_LD") {
                                // item 1891
                                dx = ex
                                dy = ey
                                dw = -ew
                                dh = eh
                            } else {
                                // item 18670008
                                if (_sw18670000_ === "FR_LE") {
                                    
                                } else {
                                    // item 18670009
                                    throw "Unexpected switch value: " + _sw18670000_;
                                }
                                // item 1892
                                dx = ex
                                dy = 0
                                dw = -ew
                                dh = 0
                            }
                        }
                    }
                }
            }
        }
    }
    // item 1843
    var width = dims.w + dw
    var height = dims.h + dh
    // item 1902
    var minSize = Config.SIZE_SNAP
    // item 2023
    if (width < minSize) {
        // item 2026
        width = dims.w
        dx = 0
    }
    // item 2027
    if (height < minSize) {
        // item 2030
        height = dims.h
        dy = 0
    }
    // item 1851
    dims.x += dx
    dims.y += dy
    dims.w = width
    dims.h = height
    // item 1853
    var block = new Utils.boxFromPoint(
    	dims.x,
    	dims.y,
    	dims.w,
    	dims.h
    );
    // item 1854
    view.selectBlock(block);
}

function FreeSizer_mouseUp(evt) {
    // item 1860
    view.hideOver();
    // item 1864
    editor.setFreeItemSize(
    	this.id,
    	this.dims.x,
    	this.dims.y,
    	this.dims.w,
    	this.dims.h
    );
    // item 1866
    evt.handled = true;
    // item 1865
    view.redraw();
}

function HandleMover(type, id) {
    // item 1915
    this.type = type;
    this.id = id;
    // item 1916
    this.mouseMove = HandleMover_mouseMove;
    this.mouseDown = HandleMover_mouseDown;
    this.mouseUp = HandleMover_mouseUp;
}

function HandleMover_mouseDown(evt) {
    // item 1922
    this.moved = false
}

function HandleMover_mouseMove(evt) {
    // item 1976
    this.moved = true
    // item 1935
    editor.moveHandle(
    	this.id,
    	this.type,
    	evt.dx,
    	evt.dy,
    	evt.x,
    	evt.y
    )
    // item 1978
    view.redraw()
    // item 1977
    evt.handled = true
}

function HandleMover_mouseUp(evt) {
    // item 1970
    if (this.moved) {
        // item 1973
        editor.saveHandlePos(this.id)
        // item 1975
        evt.handled = true
        // item 1974
        view.redraw()
    }
}

function HyperLinker(link) {
    // item 2089
    this.link = link
    // item 2090
    this.mouseDown = function() {}
    this.mouseMove = function() {}
    // item 2091
    this.mouseUp = function(evt) {
    	evt.handled = true
    	HtmlUtils.openInNewTab(link)
    }
}

function MindSizer(isLeft, id, dims) {
    // item 2114
    this.isLeft = isLeft
    this.id = id
    this.dims = dims
    // item 2152
    this.left = dims.x - dims.w
    this.right = dims.x + dims.w
    this.width = dims.w * 2
    // item 2115
    this.mouseMove = MindSizer_mouseMove
    this.mouseDown = MindSizer_mouseDown
    this.mouseUp = MindSizer_mouseUp
}

function MindSizer_mouseDown(evt) {
    // item 2121
    this.start = new Utils.Point(evt.x, evt.y);
    // item 2122
    view.showOver();
}

function MindSizer_mouseMove(evt) {
    // item 2130
    var dx, left, right
    // item 2131
    if (this.isLeft) {
        // item 2134
        dx = -evt.dx
    } else {
        // item 2135
        dx = evt.dx
    }
    // item 2128
    var width = this.width + dx
    // item 2129
    width = Math.max(
    	width,
    	Config.MIN_ICON_WIDTH * 2
    )
    // item 2136
    this.width = width
    // item 2156
    var dims = this.dims
    var top = dims.y - dims.h
    var bottom = dims.y + dims.h
    // item 2153
    if (this.isLeft) {
        // item 2137
        left = this.right - width
        right = this.right
    } else {
        // item 2157
        left = this.left
        right = this.left + width
    }
    // item 2138
    var block = new Utils.Box(
    	left,
    	top,
    	right,
    	bottom
    )
    // item 2139
    view.selectBlock(block)
}

function MindSizer_mouseUp(evt) {
    // item 2145
    view.hideOver()
    // item 2146
    if (this.width) {
        // item 2158
        var width = Utils.snapUp(this.width / 2)
        // item 2149
        editor.setItemWidth(this.id, width)
        // item 2151
        evt.handled = true
        // item 2150
        view.redraw()
    }
}

function MouseRoot_AfterClick_mouseDown(self, evt) {
    // item 1391
    if (evt.button == LEFT_BUTTON) {
        // item 1423
        var draggable =
          editor.findVisualItem(
            evt.x,
            evt.y
        );
        // item 1424
        if (((draggable) && (self.old)) && (self.old.id == draggable.id)) {
            // item 1399
            doubleClick(evt);
        } else {
            // item 1428
            click(evt);
        }
    }
    // item 1398
    self.state = "Idle";
}

function MouseRoot_AfterClick_mouseMove(self, evt) {
    // item 1394
    self.state = "AfterClick";
}

function MouseRoot_AfterClick_mouseUp(self, evt) {
    // item 1397
    self.state = "Idle";
}

function MouseRoot_AfterClick_timeout(self, evt) {
    // item 1397
    self.state = "Idle";
}

function MouseRoot_Idle_mouseDown(self, evt) {
    var _sw7480000_ = 0;
    // item 7480000
    _sw7480000_ = evt.button;
    // item 7480001
    if (_sw7480000_ === LEFT_BUTTON) {
        // item 1811
        self.downEvt = evt;
        // item 801
        var draggable =
          editor.findDraggable(
            evt.x,
            evt.y
        );
        self.moved = 0;
        self.old = draggable;
        // item 815
        self.dragger = chooseDragger(
        	draggable
        )
        // item 854
        self.dragger.mouseDown(evt);
        // item 733
        self.state = "LeftDrag";
    } else {
        // item 7480002
        if (_sw7480000_ === MIDDLE_BUTTON) {
            // item 761
            self.state = "MiddleDrag";
        } else {
            // item 7480003
            if (_sw7480000_ === RIGHT_BUTTON) {
                // item 2054
                var draggable =
                  editor.findDraggable(
                    evt.x,
                    evt.y
                )
                // item 2058
                if (draggable) {
                    // item 2055
                    if (draggable.type == Const.DRN_SOCKET) {
                        // item 2057
                        self.state = "Idle";
                    } else {
                        // item 762
                        self.state = "RightDrag";
                    }
                } else {
                    // item 762
                    self.state = "RightDrag";
                }
            } else {
                // item 2066
                self.state = "Idle";
            }
        }
    }
}

function MouseRoot_Idle_mouseMove(self, evt) {
    // item 824
    var draggable =
      editor.findVisualItem(
        evt.x,
        evt.y
    );
    // item 852
    var cursor = findCursorType(draggable);
    // item 829
    view.setCursor(cursor);
    // item 747
    self.state = "Idle";
}

function MouseRoot_Idle_mouseUp(self, evt) {
    // item 747
    self.state = "Idle";
}

function MouseRoot_LeftDrag_mouseDown(self, evt) {
    // item 757
    self.state = "LeftDrag";
}

function MouseRoot_LeftDrag_mouseMove(self, evt) {
    // item 1812
    self.moved = difference(evt, self.downEvt)
    // item 1430
    if (self.moved > Config.MOUSE_START) {
        // item 853
        self.dragger.mouseMove(evt);
    }
    // item 1432
    self.state = "LeftDrag";
}

function MouseRoot_LeftDrag_mouseUp(self, evt) {
    // item 859
    self.dragger.mouseUp(evt);
    // item 1440
    if (self.moved > Config.MOUSE_START) {
        // item 857
        self.state = "Idle";
    } else {
        // item 1412
        if (evt.handled) {
            // item 857
            self.state = "Idle";
        } else {
            // item 1357
            click(evt);
            // item 1358
            setTimeout(
            	self,
            	Config.DOUBLE_CLICK
            );
            // item 1389
            self.state = "AfterClick";
        }
    }
}

function MouseRoot_MiddleDrag_mouseDown(self, evt) {
    // item 760
    self.state = "MiddleDrag";
}

function MouseRoot_MiddleDrag_mouseMove(self, evt) {
    // item 860
    view.scrollBy(
    	evt.dx,
    	evt.dy
    );
    // item 760
    self.state = "MiddleDrag";
}

function MouseRoot_MiddleDrag_mouseUp(self, evt) {
    // item 870
    self.state = "Idle";
}

function MouseRoot_RightDrag_mouseDown(self, evt) {
    // item 736
    self.state = "RightDrag";
}

function MouseRoot_RightDrag_mouseMove(self, evt) {
    // item 736
    self.state = "RightDrag";
}

function MouseRoot_RightDrag_mouseUp(self, evt) {
    // item 896
    rightClick(
    	evt.x,
    	evt.y,
    	evt.cx,
    	evt.cy,
    	true
    );
    // item 880
    self.state = "Idle";
}

function Mover() {
    // item 1203
    this.mouseDown = Mover_mouseDown;
    this.mouseMove = Mover_mouseMove;
    this.mouseUp = Mover_mouseUp;
}

function Mover_mouseDown(message) {
    // item 2048
    this.moved = false
    // item 1233
    var item = editor.findVisualItem(
    	message.x,
    	message.y
    );
    // item 1234
    if (item) {
        // item 1209
        editor.startVisualDrag(item.id);
    }
}

function Mover_mouseMove(message) {
    // item 2049
    this.moved = true
    // item 2079
    var visible = view.getVisibleBox()
    // item 1238
    editor.visualDrag(
    	message.dx,
    	message.dy,
    	visible
    );
    // item 1225
    view.redraw();
}

function Mover_mouseUp(message) {
    // item 2050
    if (this.moved) {
        // item 1237
        editor.endVisualDrag();
        // item 2078
        view.redraw();
    }
}

function Scroller2() {
    // item 2183
    this.mouseMove = function(evt) {
    	view.scrollBy(
    		evt.dx,
    		evt.dy
    	);
    }
    // item 2184
    this.mouseDown = function(){}
    this.mouseUp = function(){}
}

function Scroller_Drag_mouseDown(self, msg) {
    // item 2201
    self.state = "Drag";
}

function Scroller_Drag_mouseMove(self, msg) {
    // item 2226
    view.scrollBy(
    	msg.dx,
    	msg.dy
    );
    // item 2223
    self.state = "Drag";
}

function Scroller_Drag_mouseUp(self, msg) {
    // item 2225
    self.state = "idle";
}

function Scroller_idle_default(self, msg) {
    // item 2211
    self.state = "idle";
}

function Scroller_idle_mouseDown(self, msg) {
    // item 2210
    self.state = "Drag";
}

function SnapDragger(target) {
    // item 965
    this.target = target;
    this.mouseMove = SnapDragger_mouseMove;
    this.mouseUp = SnapDragger_mouseUp;
    this.mouseDown = SnapDragger_mouseDown;
}

function SnapDragger_mouseDown(message) {
    // item 927
    this.snapX = new Utils.Snapper(Config.SNAP);
    this.snapY = new Utils.Snapper(Config.SNAP);
    // item 2176
    snapPos(message)
    // item 966
    this.target.mouseDown(message);
}

function SnapDragger_mouseMove(message) {
    // item 939
    this.snapX.snapMove(message.dx);
    this.snapY.snapMove(message.dy);
    // item 940
    if ((this.snapX.step) || (this.snapY.step)) {
        // item 2177
        snapPos(message)
        // item 945
        this.target.mouseMove({
        	x: message.x,
        	y: message.y,
        	dx: this.snapX.snapped,
        	dy: this.snapY.snapped
        });
    }
}

function SnapDragger_mouseUp(message) {
    // item 1002
    this.target.mouseUp(message);
}

function SocketClicker_idle_default(self, message) {
    // item 1310
    self.state = "idle";
}

function SocketClicker_idle_mouseDown(self, message) {
    // item 1294
    var socket = editor.findSocket(
    	message.x,
    	message.y
    );
    // item 1306
    if (socket) {
        // item 1344
        self.socket = socket;
        // item 1314
        editor.fireSocket(socket);
        // item 1354
        view.redraw();
        // item 1308
        self.state = "onsocket";
    } else {
        // item 1289
        self.state = "idle";
    }
}

function SocketClicker_offsocket_mouseDown(self, message) {
    // item 1292
    self.state = "offsocket";
}

function SocketClicker_offsocket_mouseMove(self, message) {
    // item 1336
    var socket = editor.findSocket(
    	message.x,
    	message.y
    );
    // item 1337
    if (socket) {
        // item 1356
        if (socket == self.socket) {
            // item 1342
            editor.fireSocket(socket);
            // item 1353
            view.redraw();
            // item 1340
            self.state = "onsocket";
        } else {
            // item 1339
            self.state = "offsocket";
        }
    } else {
        // item 1339
        self.state = "offsocket";
    }
}

function SocketClicker_offsocket_mouseUp(self, message) {
    // item 1341
    self.state = "idle";
}

function SocketClicker_onsocket_mouseDown(self, message) {
    // item 1297
    self.state = "onsocket";
}

function SocketClicker_onsocket_mouseMove(self, message) {
    // item 1322
    var socket = editor.findSocket(
    	message.x,
    	message.y
    );
    // item 1323
    if (socket == self.socket) {
        // item 1326
        self.state = "onsocket";
    } else {
        // item 1328
        editor.darkenSocket(self.socket);
        // item 1355
        view.redraw();
        // item 1325
        self.state = "offsocket";
    }
}

function SocketClicker_onsocket_mouseUp(self, message) {
    // item 1343
    editor.clickSocket(self.socket);
    // item 1413
    message.handled = true;
    // item 1352
    view.redraw();
    // item 1327
    self.state = "idle";
}

function Toucher_Drag_touchend(self, evt) {
    // item 1645
    self.dragger.mouseUp(evt);
    // item 1601
    self.state = "Idle";
}

function Toucher_Drag_touchmove(self, evt) {
    // item 1644
    self.dragger.mouseMove(evt);
    // item 1603
    self.state = "Drag";
}

function Toucher_Drag_touchstart(self, evt) {
    // item 1597
    self.state = "Idle";
}

function Toucher_Idle_touchend(self, evt) {
    // item 1524
    self.state = "Idle";
}

function Toucher_Idle_touchmove(self, evt) {
    // item 1524
    self.state = "Idle";
}

function Toucher_Idle_touchstart(self, evt) {
    // item 1626
    self.downEvt = evt;
    // item 1540
    var draggable =
      editor.findDraggable(
        evt.x,
        evt.y
    );
    self.moved = 0;
    self.old = draggable;
    // item 2317
    self.dragger = chooseDragger(
    	draggable
    )
    // item 1556
    self.dragger.mouseDown(
    	self.downEvt
    );
    // item 1627
    setTimeout(self, 600);
    // item 1510
    self.state = "LongOrShortTap";
}

function Toucher_LongOrShortTap_timeout(self, evt) {
    // item 1631
    if (self.moved > Config.TOUCH_START) {
        // item 1633
        self.state = "Drag";
    } else {
        // item 1580
        longTap(self.downEvt);
        // item 1630
        self.state = "Idle";
    }
}

function Toucher_LongOrShortTap_touchend(self, evt) {
    // item 1559
    self.dragger.mouseUp(evt);
    // item 1616
    if (self.moved > Config.TOUCH_START) {
        
    } else {
        // item 1604
        if (evt.handled) {
            
        } else {
            // item 1646
            rightClick(
            	evt.x,
            	evt.y,
            	evt.cx,
            	evt.cy,
            	false,
            	false
            );
        }
    }
    // item 1592
    self.state = "Idle";
}

function Toucher_LongOrShortTap_touchmove(self, evt) {
    // item 1582
    self.moved = difference(evt, self.downEvt)
    // item 1555
    self.dragger.mouseMove(evt);
    // item 1612
    if (self.moved > Config.TOUCH_START) {
        // item 1634
        self.state = "Drag";
    } else {
        // item 1614
        self.state = "LongOrShortTap";
    }
}

function Toucher_LongOrShortTap_touchstart(self, evt) {
    // item 1534
    self.state = "Idle";
}

function WheelScroller_idle_default(self, message) {
    // item 1069
    self.state = "idle";
}

function WheelScroller_idle_mouseWheel(self, message) {
    // item 1097
    if (message.ctrlKey) {
        // item 1080
        handleWheel(self, message, true);
        // item 1050
        self.state = "zooming";
    } else {
        // item 1100
        handleWheel(self, message, false);
        // item 1099
        self.state = "panning";
    }
}

function WheelScroller_panning_default(self, message) {
    // item 1078
    self.state = "panning";
}

function WheelScroller_panning_mouseWheel(self, message) {
    // item 1101
    handleWheel(self, message, false);
    // item 1053
    self.state = "panning";
}

function WheelScroller_panning_timeout(self, message) {
    // item 1081
    view.finishScroll();
    // item 1079
    self.state = "idle";
}

function WheelScroller_zooming_default(self, message) {
    // item 1093
    self.state = "zooming";
}

function WheelScroller_zooming_mouseWheel(self, message) {
    // item 1469
    if (message.ctrlKey) {
        // item 1102
        handleWheel(self, message, true);
        // item 1085
        self.state = "zooming";
    } else {
        // item 1471
        finishZoom()
        // item 1472
        handleWheel(self, message, false);
        // item 1473
        self.state = "panning";
    }
}

function WheelScroller_zooming_timeout(self, message) {
    // item 1803
    finishZoom()
    // item 1094
    self.state = "idle";
}

function chooseDragger(draggable) {
    // item 2295
    if (draggable) {
        // item 2294
        return chooseDragger2(
        	draggable.type,
        	draggable.id,
        	draggable.dims,
        	draggable.data
        )
    } else {
        // item 2298
        return getDefaultDragger()
    }
}

function chooseDragger2(type, id, dims, data) {
    // item 2268
    if (type) {
        
    } else {
        // item 2271
        throw Error("chooseDragger: type is null, id: " + id)
    }
    // item 2242
    var handler;
    var result;
    // item 22320001
    if (type === Const.LINK) {
        // item 2277
        result = new HyperLinker(data)
    } else {
        // item 22320002
        if (type === Const.DRN_SOCKET) {
            // item 2280
            result = new SocketClicker(id);
        } else {
            // item 2246
            result = getDefaultDragger()
        }
    }
    // item 2248
    return result;
}

function clearTimeout(id) {
    // item 1501
    window.clearTimeout(id);
}

function click(evt) {
    // item 1367
    var result = editor.mouseClick(evt.x, evt.y);
    // item 1377
    callbacks.click();
    // item 1368
    if (result.mustRedraw) {
        // item 1371
        view.redraw();
    }
}

function difference(evt1, evt2) {
    // item 1809
    var dx = Math.abs(evt2.cx - evt1.cx)
    var dy = Math.abs(evt2.cy - evt1.cy)
    // item 1810
    return Math.max(dx, dy)
}

function distance(evt) {
    // item 1439
    return Math.sqrt(
    	evt.dx * evt.dx +
    	evt.dy * evt.dy
    )
}

function doubleClick(evt) {
    // item 1411
    var x = evt.x;
    var y = evt.y;
    // item 1406
    var itemId = editor.canEditText(x, y);
    // item 1407
    if (itemId) {
        // item 1410
        editor.startEditTextAt(itemId, x, y);
    }
}

function draw(ctx) {
    // item 460
    canvas.draw(ctx);
}

function endFreeScroll() {
    // item 1783
    resetMachines()
    // item 2108
    view.setCursor("auto");
}

function enrichMenu(menu, callbackClick) {
    var _sw9860000_ = 0;
    // item 9840001
    var _ind984 = 0;
    var _col984 = menu;
    var _len984 = _col984.length;
    while (true) {
        // item 9840002
        if (_ind984 < _len984) {
            
        } else {
            break;
        }
        // item 9840004
        var item = _col984[_ind984];
        // item 9860000
        _sw9860000_ = item.type;
        // item 9860001
        if (_sw9860000_ === "menu") {
            // item 994
            enrichMenu(item.items, callbackClick);
        } else {
            // item 9860002
            if (_sw9860000_ === "separator") {
                
            } else {
                // item 995
                item.code = wrapInRedraw(item.code, callbackClick, item.text)
            }
        }
        // item 9840003
        _ind984++;
    }
}

function externalClick(evt) {
    // item 1420
    var message = view.toDiagram(evt);
    // item 1421
    mouseDown(message);
    mouseUp(message);
}

function findCursorType(draggable) {
    var _sw8400000_ = 0;
    // item 835
    if (draggable) {
        // item 8400000
        _sw8400000_ = draggable.type;
        // item 8400001
        if ((_sw8400000_ === Const.DRN_MOVE) || (_sw8400000_ === Const.DRN_MOVE_ALL)) {
            // item 839
            return "move";
        } else {
            // item 8400003
            if (_sw8400000_ === Const.TEXT) {
                // item 2287
                return "text"
            } else {
                // item 8400004
                if (_sw8400000_ === Const.LINK) {
                    // item 2082
                    return "pointer"
                } else {
                    // item 8400005
                    if ((((_sw8400000_ === Const.DRN_SIZE_L) || (_sw8400000_ === Const.DRN_SIZE_R)) || (_sw8400000_ === Const.MIND_SIZE_L)) || (_sw8400000_ === Const.MIND_SIZE_R)) {
                        // item 847
                        return "ew-resize";
                    } else {
                        // item 8400009
                        if ((_sw8400000_ === Const.LINE_START) || (_sw8400000_ === Const.LINE_END)) {
                            // item 2017
                            return "move";
                        } else {
                            // item 1899
                            var type = cursors[draggable.type]
                            // item 1901
                            if (type) {
                                // item 1900
                                return type
                            } else {
                                // item 838
                                return "default"
                            }
                        }
                    }
                }
            }
        }
    } else {
        // item 838
        return "default"
    }
}

function finishZoom() {
    // item 2102
    canvas.fast = false
    // item 1802
    view.finishZoom()
    // item 1801
    callbacks.onFinishZoom()
}

function getBackground() {
    // item 1983
    return canvas.getBackground()
}

function getDefaultDragger() {
    // item 2308
    if (gSelectMode) {
        // item 2310
        return new BlockSelector()
    } else {
        // item 2311
        return new Scroller()
    }
}

function getTime() {
    // item 1453
    var date = new Date();
    return date.getTime();
}

function handleWheel(self, message, zoom) {
    // item 1118
    if (self.timer) {
        // item 1116
        clearTimeout(self.timer);
        self.timer = null;
    }
    // item 1121
    self.timer = 
      setTimeout(self, Config.WHEEL_TIMEOUT);
    // item 1136
    var raw = 
      throttleWheel(self, message.delta);
    // item 1466
    if (raw == 0) {
        
    } else {
        // item 1133
        if (zoom) {
            // item 2101
            canvas.fast = true
            // item 1137
            view.zoomBy(raw);
        } else {
            // item 1123
            var dx, dy;
            // item 1124
            if (message.shiftKey) {
                // item 1128
                dx = raw;
                dy = 0;
            } else {
                // item 1127
                dx = 0;
                dy = raw;
            }
            // item 1447
            var zoom = view.getZoom();
            // item 1448
            dx = Math.floor(dx / zoom);
            dy = Math.floor(dy / zoom);
            // item 1122
            view.scrollBy(dx, dy);
        }
    }
}

function longTap(evt) {
    // item 1652
    click(evt);
    // item 1653
    doubleClick(evt);
}

function mouseDown(evt) {
    // item 2106
    HtmlUtils.unfocus()
    // item 1180
    gMouse.mouseDown(evt);
}

function mouseMove(evt) {
    // item 1186
    gMouse.mouseMove(evt);
}

function mouseUp(evt) {
    // item 1192
    gMouse.mouseUp(evt);
}

function mouseWheel(evt) {
    // item 1198
    gWheel.mouseWheel(evt);
}

function redrawCache() {
    // item 702
    editor.redraw();
}

function resetMachines() {
    // item 2046
    gRoot = new MouseRoot();
    gMouse = gRoot;
    gWheel = new WheelScroller();
    gTouch = new Toucher();
    gScroll = new FreeScroll();
}

function rightClick(x, y, cx, cy, always, block) {
    // item 1414
    click({ x: x, y: y });
    // item 1984
    if ((always) || (!(block))) {
        // item 973
        var result = editor.buildMenuAt(x, y);
        // item 974
        if (result.menu) {
            // item 2103
            var menuObj = {
            	rows: result.menu,
            	item: result.item
            }
            // item 978
            enrichMenu(result.menu, true);
            context(
            	cx,
            	cy,
            	menuObj,
            	externalClick,
            	result.item
            );
        }
    }
}

function setTimeout(target, milliseconds) {
    // item 1494
    var callback = function() {
    	target.timeout();
    }
    // item 1495
    return window.setTimeout(callback, milliseconds);
}

function setTransform(dx, dy, zoom, retina) {
    // item 2100
    canvas.setTransform(dx, dy, zoom, retina)
}

function setZoom(zoom, retina) {
    // item 708
    canvas.zoom = zoom;
    canvas.retina = retina;
}

function shouldBlockMenu(x, y) {
    // item 1994
    var ids = editor.getSelection()
    // item 1998
    if (ids.length == 0) {
        // item 2002
        return false
    } else {
        // item 2006
        var item = editor.findVisualItem(x, y)
        // item 2003
        if (item) {
            // item 2002
            return false
        } else {
            // item 2001
            return true
        }
    }
}

function snapPos(message) {
    // item 2175
    message.x = Utils.snapPos(message.x)
    message.y = Utils.snapPos(message.y)
}

function startFreeScroll() {
    // item 2053
    resetMachines()
    // item 1784
    gMouse = gScroll;
    // item 2107
    view.setCursor("move");
}

function throttleWheel(self, delta) {
    // item 1455
    var amount;
    // item 1459
    var now = getTime();
    // item 1456
    if (self.prev) {
        // item 1461
        var passed = now - self.prev;
        // item 1462
        if (passed < Config.WHEEL_THROTTLE) {
            // item 1465
            amount = 0;
        } else {
            // item 1460
            self.prev = now;
            // item 1446
            amount = Config.WHEEL_STEP;
        }
    } else {
        // item 1460
        self.prev = now;
        // item 1446
        amount = Config.WHEEL_STEP;
    }
    // item 1441
    if (delta < 0) {
        // item 1444
        amount = -amount;
    }
    // item 1454
    return amount;
}

function toNormalMode() {
    // item 2313
    gSelectMode = false
    // item 2314
    resetMachines()
}

function toSelectionMode() {
    // item 2315
    gSelectMode = true
    // item 2316
    resetMachines()
}

function touchEnd(evt) {
    // item 1793
    if (gMouse == gScroll) {
        // item 1796
        gScroll.mouseUp(evt);
    } else {
        // item 1617
        gTouch.touchend(evt);
    }
}

function touchMove(evt) {
    // item 1789
    if (gMouse == gScroll) {
        // item 1792
        gScroll.mouseMove(evt);
    } else {
        // item 1618
        gTouch.touchmove(evt);
    }
}

function touchStart(evt) {
    // item 1785
    if (gMouse == gScroll) {
        // item 1788
        gScroll.mouseDown(evt);
    } else {
        // item 1619
        gTouch.touchstart(evt);
    }
}

function wrapInRedraw(action, callbackClick, text) {
    // item 1001
    return function(x, y) {
    	CallTrace.reset()
    	if (text) CallTrace.add("cm:" + text)
    	action(x, y)
    	view.hideOver()
    	view.redraw()
    	if (callbackClick) callbacks.click()
    }
}

function MouseRoot() {
  var _self = this;
  _self.type_name = "MouseRoot";
  _self.state = "Idle";
  _self.mouseDown = function(evt) {
    var _state_ = _self.state;
    if (_state_ == "Idle") {
      return MouseRoot_Idle_mouseDown(_self, evt);
    }
    else if (_state_ == "LeftDrag") {
      return MouseRoot_LeftDrag_mouseDown(_self, evt);
    }
    else if (_state_ == "AfterClick") {
      return MouseRoot_AfterClick_mouseDown(_self, evt);
    }
    else if (_state_ == "MiddleDrag") {
      return MouseRoot_MiddleDrag_mouseDown(_self, evt);
    }
    else if (_state_ == "RightDrag") {
      return MouseRoot_RightDrag_mouseDown(_self, evt);
    }
    return null;
  };
  _self.mouseMove = function(evt) {
    var _state_ = _self.state;
    if (_state_ == "Idle") {
      return MouseRoot_Idle_mouseMove(_self, evt);
    }
    else if (_state_ == "LeftDrag") {
      return MouseRoot_LeftDrag_mouseMove(_self, evt);
    }
    else if (_state_ == "AfterClick") {
      return MouseRoot_AfterClick_mouseMove(_self, evt);
    }
    else if (_state_ == "MiddleDrag") {
      return MouseRoot_MiddleDrag_mouseMove(_self, evt);
    }
    else if (_state_ == "RightDrag") {
      return MouseRoot_RightDrag_mouseMove(_self, evt);
    }
    return null;
  };
  _self.mouseUp = function(evt) {
    var _state_ = _self.state;
    if (_state_ == "Idle") {
      return MouseRoot_Idle_mouseUp(_self, evt);
    }
    else if (_state_ == "LeftDrag") {
      return MouseRoot_LeftDrag_mouseUp(_self, evt);
    }
    else if (_state_ == "AfterClick") {
      return MouseRoot_AfterClick_mouseUp(_self, evt);
    }
    else if (_state_ == "MiddleDrag") {
      return MouseRoot_MiddleDrag_mouseUp(_self, evt);
    }
    else if (_state_ == "RightDrag") {
      return MouseRoot_RightDrag_mouseUp(_self, evt);
    }
    return null;
  };
  _self.timeout = function(evt) {
    var _state_ = _self.state;
    if (_state_ == "AfterClick") {
      return MouseRoot_AfterClick_timeout(_self, evt);
    }
    return null;
  };
}

function WheelScroller() {
  var _self = this;
  _self.type_name = "WheelScroller";
  _self.state = "idle";
  _self.mouseWheel = function(message) {
    var _state_ = _self.state;
    if (_state_ == "idle") {
      return WheelScroller_idle_mouseWheel(_self, message);
    }
    else if (_state_ == "panning") {
      return WheelScroller_panning_mouseWheel(_self, message);
    }
    else if (_state_ == "zooming") {
      return WheelScroller_zooming_mouseWheel(_self, message);
    }
    return null;
  };
  _self.timeout = function(message) {
    var _state_ = _self.state;
    if (_state_ == "idle") {
      return WheelScroller_idle_default(_self, message);
    }
    else if (_state_ == "panning") {
      return WheelScroller_panning_timeout(_self, message);
    }
    else if (_state_ == "zooming") {
      return WheelScroller_zooming_timeout(_self, message);
    }
    return null;
  };
}

function SocketClicker() {
  var _self = this;
  _self.type_name = "SocketClicker";
  _self.state = "idle";
  _self.mouseDown = function(message) {
    var _state_ = _self.state;
    if (_state_ == "idle") {
      return SocketClicker_idle_mouseDown(_self, message);
    }
    else if (_state_ == "onsocket") {
      return SocketClicker_onsocket_mouseDown(_self, message);
    }
    else if (_state_ == "offsocket") {
      return SocketClicker_offsocket_mouseDown(_self, message);
    }
    return null;
  };
  _self.mouseMove = function(message) {
    var _state_ = _self.state;
    if (_state_ == "idle") {
      return SocketClicker_idle_default(_self, message);
    }
    else if (_state_ == "onsocket") {
      return SocketClicker_onsocket_mouseMove(_self, message);
    }
    else if (_state_ == "offsocket") {
      return SocketClicker_offsocket_mouseMove(_self, message);
    }
    return null;
  };
  _self.mouseUp = function(message) {
    var _state_ = _self.state;
    if (_state_ == "idle") {
      return SocketClicker_idle_default(_self, message);
    }
    else if (_state_ == "onsocket") {
      return SocketClicker_onsocket_mouseUp(_self, message);
    }
    else if (_state_ == "offsocket") {
      return SocketClicker_offsocket_mouseUp(_self, message);
    }
    return null;
  };
}

function Toucher() {
  var _self = this;
  _self.type_name = "Toucher";
  _self.state = "Idle";
  _self.timeout = function(evt) {
    var _state_ = _self.state;
    if (_state_ == "LongOrShortTap") {
      return Toucher_LongOrShortTap_timeout(_self, evt);
    }
    return null;
  };
  _self.touchend = function(evt) {
    var _state_ = _self.state;
    if (_state_ == "Idle") {
      return Toucher_Idle_touchend(_self, evt);
    }
    else if (_state_ == "LongOrShortTap") {
      return Toucher_LongOrShortTap_touchend(_self, evt);
    }
    else if (_state_ == "Drag") {
      return Toucher_Drag_touchend(_self, evt);
    }
    return null;
  };
  _self.touchmove = function(evt) {
    var _state_ = _self.state;
    if (_state_ == "Idle") {
      return Toucher_Idle_touchmove(_self, evt);
    }
    else if (_state_ == "LongOrShortTap") {
      return Toucher_LongOrShortTap_touchmove(_self, evt);
    }
    else if (_state_ == "Drag") {
      return Toucher_Drag_touchmove(_self, evt);
    }
    return null;
  };
  _self.touchstart = function(evt) {
    var _state_ = _self.state;
    if (_state_ == "Idle") {
      return Toucher_Idle_touchstart(_self, evt);
    }
    else if (_state_ == "LongOrShortTap") {
      return Toucher_LongOrShortTap_touchstart(_self, evt);
    }
    else if (_state_ == "Drag") {
      return Toucher_Drag_touchstart(_self, evt);
    }
    return null;
  };
}

function FreeScroll() {
  var _self = this;
  _self.type_name = "FreeScroll";
  _self.state = "Idle";
  _self.mouseDown = function(evt) {
    var _state_ = _self.state;
    if (_state_ == "Idle") {
      return FreeScroll_Idle_mouseDown(_self, evt);
    }
    else if (_state_ == "Drag") {
      return FreeScroll_Drag_mouseDown(_self, evt);
    }
    return null;
  };
  _self.mouseMove = function(evt) {
    var _state_ = _self.state;
    if (_state_ == "Idle") {
      return FreeScroll_Idle_mouseMove(_self, evt);
    }
    else if (_state_ == "Drag") {
      return FreeScroll_Drag_mouseMove(_self, evt);
    }
    return null;
  };
  _self.mouseUp = function(evt) {
    var _state_ = _self.state;
    if (_state_ == "Idle") {
      return FreeScroll_Idle_mouseUp(_self, evt);
    }
    else if (_state_ == "Drag") {
      return FreeScroll_Drag_mouseUp(_self, evt);
    }
    return null;
  };
}

function Scroller() {
  var _self = this;
  _self.type_name = "Scroller";
  _self.state = "idle";
  _self.mouseDown = function(msg) {
    var _state_ = _self.state;
    if (_state_ == "idle") {
      return Scroller_idle_mouseDown(_self, msg);
    }
    else if (_state_ == "Drag") {
      return Scroller_Drag_mouseDown(_self, msg);
    }
    return null;
  };
  _self.mouseMove = function(msg) {
    var _state_ = _self.state;
    if (_state_ == "idle") {
      return Scroller_idle_default(_self, msg);
    }
    else if (_state_ == "Drag") {
      return Scroller_Drag_mouseMove(_self, msg);
    }
    return null;
  };
  _self.mouseUp = function(msg) {
    var _state_ = _self.state;
    if (_state_ == "idle") {
      return Scroller_idle_default(_self, msg);
    }
    else if (_state_ == "Drag") {
      return Scroller_Drag_mouseUp(_self, msg);
    }
    return null;
  };
}


var gRoot
var gMouse
var gWheel
var gTouch
var gScroll

var gSelectMode = true

resetMachines()

var gHandlers = {}

}
