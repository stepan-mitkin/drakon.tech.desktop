function Main2(window, document, translate, contentPath) {


var DarkBackground = "#455A64"

var LineHeight = 34
var MobileWidth = 700
var BigWidth = 1000
var LogonWidth = 300

var globs = {}
var SignUpFirst = false

globs.resizer = null

var logonCtrl = new Logon(window, document, translate)


// Autogenerated with DRAKON Editor 1.32


function acceptCookies() {
    // item 361
    display("cookie_warning", "none")
    // item 360
    HtmlUtils.setCookie(
        "cookies_accepted",
        "true",
        30
    )
}

function activateBasic() {
    // item 519
    console.log("activateBasic")
}

function addPopupItem(div, item) {
    // item 86
    if (item.type == "separator") {
        // item 89
        var hr = make(div, "hr")
        hr.style.margin = "0px"
    } else {
        // item 83
        var callback = function(evt) {
        	hidePopup()
        	item.code(evt)
        }
        // item 84
        var row = make(div, "div")
        row.className = "list_item"
        row.style.height = LineHeight + "px"
        // item 91
        var textPart = makeIB(row)
        textPart.style.padding = "8px"
        // item 90
        HtmlUtils.setDivText(
        	textPart,
        	translate(item.text)
        )
        // item 92
        var itemId = item.id || ""
        // item 85
        row.onclick = callback
    }
}

function agreeChanged(agree) {
    // item 310
    if (agree) {
        // item 313
        display("create_account", "block")
        display("create_account_grey", "none")
    } else {
        // item 314
        display("create_account", "none")
        display("create_account_grey", "block")
    }
}

function createPopupList(items) {
    // item 110
    var div = HtmlUtils.createPopup()
    // item 111
    div.className = "popup"
    div.style.background = "white"
    // item 1120001
    var _ind112 = 0;
    var _col112 = items;
    var _len112 = _col112.length;
    while (true) {
        // item 1120002
        if (_ind112 < _len112) {
            
        } else {
            break;
        }
        // item 1120004
        var item = _col112[_ind112];
        // item 114
        addPopupItem(div, item)
        // item 1120003
        _ind112++;
    }
    // item 115
    return div
}

function disablePurchaseButton(id) {
    var active, nothing, purchase, trial
    // item 449
    trial = document.getElementById("start_trial")
    purchase = document.getElementById("purchase")
    active = document.getElementById(id)
    // item 452
    nothing = function() {}
    // item 450
    trial.onclick = nothing
    purchase.onclick = nothing
    // item 451
    HtmlUtils.setText(id, translate("MES_WORKING"))
}

function disableSignupOk() {
    // item 381
    display("create_account", "none")
    display("create_account_grey", "none")
}

function display(id, value) {
    var div
    // item 220
    div = document.getElementById(id)
    // item 435
    if (div) {
        // item 221
        div.style.display = value
    }
}

function displayMany(className, value) {
    var divs
    // item 408
    divs = document.getElementsByClassName(className)
    // item 4090001
    var _ind409 = 0;
    var _col409 = divs;
    var _len409 = _col409.length;
    while (true) {
        // item 4090002
        if (_ind409 < _len409) {
            
        } else {
            break;
        }
        // item 4090004
        var div = _col409[_ind409];
        // item 411
        div.style.display = value
        // item 4090003
        _ind409++;
    }
}

function enableSignupOk() {
    // item 380
    display("create_account", "block")
    display("create_account_grey", "none")
}

function get(id) {
    // item 134
    var element = document.getElementById(id)
    // item 131
    if (element) {
        // item 135
        return element
    } else {
        // item 136
        throw Error("Element '" + id + "' not found")
    }
}

function getLanguageNeutral() {
    var languages, part, path, path2, result
    // item 49
    path = window.location.pathname
    // item 55
    languages = ["en", "ru"]
    // item 560001
    var _ind56 = 0;
    var _col56 = languages;
    var _len56 = _col56.length;
    while (true) {
        // item 560002
        if (_ind56 < _len56) {
            
        } else {
            // item 58
            path2 = path
            break;
        }
        // item 560004
        var language = _col56[_ind56];
        // item 50
        part = "/" + language
        // item 51
        if (Utils.startsWith(path, part)) {
            // item 54
            result = path.substring(part.length)
            // item 417
            if (result) {
                // item 420
                path2 = result
            } else {
                // item 421
                path2 = "/"
            }
            break;
        }
        // item 560003
        _ind56++;
    }
    // item 492
    return path2 + window.location.search
}

function getLanguagePopupItems() {
    var english, items, russian
    // item 24
    english = {
        text : "English",
        code : switchToEnglish
    }
    // item 25
    russian = {
        text : "Russian",
        code : switchToRussian
    }
    // item 26
    items = [english, russian]
    // item 23
    return items
}

function getQueryParameter(name) {
    var search
    // item 526
    search = Utils.parseSearch(
        window.location.search
    )
    // item 525
    return search[name]
}

function getRef() {
    // item 471
    return getQueryParameter("ref")
}

function getUserPopupItems() {
    var goToUserAccount, items, logoutItem, user
    // item 178
    goToUserAccount = function() {
        goTo("/account")
    }
    // item 174
    user = {
        text : "MES_USER_ACCOUNT",
        code : goToUserAccount
    }
    // item 175
    logoutItem = {
        text : "Logout",
        code : logout
    }
    // item 176
    items = [user, logoutItem]
    // item 177
    return items
}

function goTo(url) {
    // item 170
    window.location.href = url
}

function goToDashboard() {
    // item 183
    goTo("/ide/dashboard")
}

function hideMobileMenu() {
    // item 225
    display("mob_menu", "none")
    display("ui", "block")
    document.body.className = "red_back"
}

function hidePopup() {
    // item 69
    HtmlUtils.hidePopup()
}

function init() {
    // item 362
    initCookies()
    // item 125
    registerClick("languages", showLanguagesPopup)
    // item 196
    registerClick("languages_mob", showLanguagesPopup)
    // item 198
    registerClick("mob_menu_butt", showMobileMenu)
    registerClick("close_mob_menu_butt", hideMobileMenu)
    // item 209
    registerEvent("account", "onclick", showUserPopup)
    // item 527
    if ((gUserId) || (!(document.getElementById("i_agree")))) {
        
    } else {
        // item 363
        globs.signupCtrl = new Signup(
            window,
            document,
            translate,
            "userName",
            "email",
            "pass",
            "pass2",
            "signup_message",
            disableSignupOk,
            onSignupOk,
            enableSignupOk,
            false
        )
    }
    // item 412
    if (gUserId) {
        // item 416
        displayMany("no_user", "none")
        displayMany("yes_user", "block")
    } else {
        // item 415
        displayMany("no_user", "block")
        displayMany("yes_user", "none")
    }
    // item 541
    if (gOnPremises) {
        
    } else {
        // item 544
        displayMany("agree", "block")
    }
}

function initCookies() {
    var divs, nothing, ref
    // item 330
    HtmlUtils.setCookie("language", gLanguage)
    // item 323
    if ((gUserId) || (userAcceptedCookies())) {
        
    } else {
        // item 329
        display("cookie_warning", "block")
    }
    // item 511
    if ((gUserId) || (!(SignUpFirst))) {
        
    } else {
        // item 507
        divs = document.getElementsByClassName(
            "must_be_logged_in"
        )
        // item 5080001
        var _ind508 = 0;
        var _col508 = divs;
        var _len508 = _col508.length;
        while (true) {
            // item 5080002
            if (_ind508 < _len508) {
                
            } else {
                break;
            }
            // item 5080004
            var div = _col508[_ind508];
            // item 510
            div.href = "/signup?tgt=" + div.href
            // item 5080003
            _ind508++;
        }
    }
    // item 340
    ref = getRef()
    // item 341
    if (ref) {
        // item 344
        nothing = function() {}
        // item 345
        HtmlUtils.sendPost(
            "/api/set_ref",
            {ref: ref},
            nothing,
            nothing
        )
    }
}

function initTrial() {
    // item 491
    display("plan", "block")
}

function logon() {
    // item 259
    logonCtrl.logon(
        "userNameLogin",
        "passLogin",
        "logon_message",
        onLogonCompleted
    )
}

function logout() {
    // item 277
    logonCtrl.logout()
}

function make(parent, tag) {
    // item 143
    var element = document.createElement(tag)
    parent.appendChild(element)
    // item 145
    //element.ontouchstart = prevent
    //element.ontouchmove = prevent
    //element.ontouchend = prevent
    // item 144
    return element
}

function makeIB(parent) {
    // item 151
    var div = make(parent, "div")
    div.style.display = "inline-block"
    // item 152
    return div
}

function makeSeparator(list) {
    // item 105
    var item = {
    	type: "separator"
    }
    // item 106
    list.push(item)
}

function makeTextListItem(list, textId, action, id, image) {
    // item 98
    var item = {
    	text: translate(textId),
    	code: action,
    	id: id,
    	image: image
    }
    // item 99
    list.push(item)
}

function onLoginPassDown(evt) {
    var _sw2460000_ = 0;
    // item 2460000
    _sw2460000_ = evt.keyCode;
    // item 2460001
    if (_sw2460000_ === 13) {
        // item 254
        logon()
    }
}

function onLoginUserDown(evt) {
    var _sw2310000_ = 0;
    // item 2310000
    _sw2310000_ = evt.keyCode;
    // item 2310001
    if (_sw2310000_ === 13) {
        // item 239
        get("passLogin").focus()
    }
}

function onLogonCompleted() {
    var target
    // item 499
    target = getQueryParameter("tgt")
    // item 500
    if (target) {
        // item 503
        goTo(target)
    } else {
        // item 268
        goToDashboard()
    }
}

function onSignupEmailDown(evt) {
    var _sw2950000_ = 0;
    // item 2950000
    _sw2950000_ = evt.keyCode;
    // item 2950001
    if (_sw2950000_ === 13) {
        // item 301
        signup()
    }
}

function onSignupOk() {
    var target, url
    // item 494
    target = getQueryParameter("tgt")
    // item 495
    if (target) {
        // item 498
        goTo(target)
    } else {
        // item 530
        url = "/welcome"
        // item 531
        if (globs.next) {
            // item 534
            url += "?next=" + globs.next
        }
        // item 371
        goTo(url)
    }
}

function onSignupUserDown(evt) {
    var _sw2830000_ = 0;
    // item 2830000
    _sw2830000_ = evt.keyCode;
    // item 2830001
    if (_sw2830000_ === 13) {
        // item 289
        get("email_edit").focus()
    }
}

function purchase() {
    var product, ref, url
    // item 465
    disablePurchaseButton("purchase")
    // item 474
    product = getQueryParameter("product") || "extended"
    ref = getQueryParameter("ref") || "trial"
    // item 475
    url = "/buy?product=" + product +
    	"&ref=" + ref
    // item 476
    goTo(url)
}

function putExamples(targetId, examples) {
    var a, img, size, target
    // item 402
    size = 160
    // item 392
    target = get(targetId)
    // item 3930001
    var _ind393 = 0;
    var _col393 = examples;
    var _len393 = _col393.length;
    while (true) {
        // item 3930002
        if (_ind393 < _len393) {
            
        } else {
            break;
        }
        // item 3930004
        var example = _col393[_ind393];
        // item 395
        a = make(target, "a")
        a.className = "example_item"
        // item 396
        img = make(a, "img")
        img.width = size
        img.height = size
        img.src = "/static/" + example.image
        img.style.verticalAlign = "bottom"
        // item 397
        if (gUserId) {
            // item 401
            a.href = example.ex
        } else {
            // item 400
            a.href = example.url
        }
        // item 3930003
        _ind393++;
    }
}

function registerClick(id, callback) {
    var div
    // item 430
    div = document.getElementById(id)
    // item 427
    if (div) {
        // item 431
        div.onclick = callback
    }
}

function registerEvent(id, event, callback) {
    var div
    // item 204
    div = document.getElementById(id)
    // item 206
    if (div) {
        // item 205
        div[event] = callback
    }
}

function reloadPage() {
    var url
    // item 45
    url = getLanguageNeutral()
    // item 44
    window.location.href = url
}

function setLanguage(lang) {
    var data, noop, reload
    // item 32
    HtmlUtils.setCookie("language", lang)
    // item 33
    noop = function() {}
    // item 34
    reload = reloadPage
    // item 35
    if (gUserId) {
        // item 39
        data = {
            language : lang
        }
        // item 40
        HtmlUtils.sendPost(
            "/api/theme",
            data,
            reload,
            noop
        )
    } else {
        // item 38
        reload()
    }
}

function showLanguagesPopup(evt) {
    var div, items
    // item 11
    div = evt.target
    // item 9
    items = getLanguagePopupItems()
    // item 10
    showPopupList(div, items)
}

function showMobileMenu() {
    // item 214
    display("ui", "none")
    display("mob_menu", "block")
    document.body.className = "white_back"
}

function showPopupList(parentDiv, items) {
    // item 124
    var div = createPopupList(items)
    // item 123
    HtmlUtils.showUnder(parentDiv, div)
}

function showUserPopup(evt) {
    var div, items
    // item 191
    div = evt.target
    // item 189
    items = getUserPopupItems()
    // item 190
    showPopupList(div, items)
}

function signup(next) {
    var product
    // item 538
    if ((gOnPremises) || (get("i_agree").checked)) {
        // item 537
        globs.next = next
        // item 493
        product = getQueryParameter("product")
        // item 319
        globs.signupCtrl.signup(
            contentPath || "main",
            product
        )
    } else {
        // item 528
        HtmlUtils.setText(
        	"signup_message",
        	translate("MES_AGREE")
        )
    }
}

function switchToEnglish() {
    // item 19
    setLanguage('en-us')
}

function switchToRussian() {
    // item 15
    setLanguage('ru')
}

function trial() {
    var onError, onSuccess, payload, product
    // item 456
    disablePurchaseButton("start_trial")
    // item 477
    product = getQueryParameter("product") || "extended"
    // item 478
    payload = {
        product : product
    }
    // item 479
    onSuccess = function() {
        goTo("/welcome-trial")
    }
    // item 480
    onError = function() {
        goTo("/")
    }
    // item 481
    HtmlUtils.sendPost(
        "/api/trial",
        payload,
        onSuccess,
        onError
    )
}

function userAcceptedCookies() {
    // item 350
    if (HtmlUtils.getCookie("cookies_accepted")) {
        // item 349
        return true
    } else {
        // item 353
        return false
    }
}


this.init = init
this.onLoginUserDown = onLoginUserDown
this.onLoginPassDown = onLoginPassDown
this.logon = logon
this.logout = logout
this.signup = signup
this.onSignupUserDown = onSignupUserDown
this.onSignupEmailDown = onSignupEmailDown
this.agreeChanged = agreeChanged
this.acceptCookies = acceptCookies
this.getRef = getRef
this.putExamples = putExamples
this.trial = trial
this.purchase = purchase
this.initTrial = initTrial
this.activateBasic = activateBasic
this.getQueryParameter = getQueryParameter
}
